var U=Object.defineProperty,Y=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;var D=(n,e,t)=>e in n?U(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,E=(n,e)=>{for(var t in e||(e={}))X.call(e,t)&&D(n,t,e[t]);if(T)for(var t of T(e))_.call(e,t)&&D(n,t,e[t]);return n},O=(n,e)=>Y(n,j(e));var d=(n,e,t)=>(D(n,typeof e!="symbol"?e+"":e,t),t);import{r as A,j as g,F as z,a as o,B as b,o as c,_ as R,e as Q,P as Z,b as P,u as N,c as q,O as $,S as M,C as G,E as K,L as J,I as ee,D as te,d as W,f as se,M as V,R as re,g as ie,h as oe,z as ne}from"./vendor.4d9e8d57.js";const ae=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}};ae();const h=8,C=h/2,ce=34;class L{constructor(e){d(this,"viewer");d(this,"sk");d(this,"store");d(this,"cropInfo",{});d(this,"buttonWrapperDiv");d(this,"pg");d(this,"eventSource");this.store=[],this.viewer=e.viewer,this.sk=e.sk,this.eventSource=e.overlayEvent,this.buttonWrapperDiv=this.sk.createDiv(),this.buttonWrapperDiv.hide(),this.buttonWrapperDiv.addClass("w-120px");const t=this.viewer.viewport.getContainerSize();this.pg=this.sk.createGraphics(t.x,t.y),A.exports.render(g(z,{children:[o(b,{size:"small",type:"primary",onClick:()=>{this.finish()},children:"\u786E\u5B9A"}),o(b,{className:"ml-4",size:"small",danger:!0,type:"primary",onClick:()=>{this.cancelCrop()},children:"\u53D6\u6D88"})]}),this.buttonWrapperDiv.elt),this.viewer.container.append(this.buttonWrapperDiv.elt)}startCrop(){if(this.cropInfo.enable)return!1;this.cropInfo.prevCanvasImage=this.sk.get(),this.viewer.setMouseNavEnabled(!1),this.viewer.drawer.canvas.toBlob(e=>{if(e){const t=URL.createObjectURL(e);this.sk.loadImage(t,s=>{this.cropInfo.seaDragonImage=s,URL.revokeObjectURL(t)})}}),this.sk.loop(),this.cropInfo.enable=!0,this.sk.mousePressed=e=>(!this.cropInfo.enable||e.target.nodeName!=="CANVAS"||this.cropInfo.onWhere||(this.cropInfo.startPoint=new c.exports.Point(this.sk.mouseX,this.sk.mouseY),this.cropInfo.currentSelected=void 0),!1),this.sk.mouseReleased=e=>{if(!this.cropInfo.enable||e.target.nodeName!=="CANVAS")return!1;this.cropInfo.currentSelected||(this.cropInfo.currentSelected=[this.cropInfo.startPoint,new c.exports.Point(this.sk.mouseX,this.sk.mouseY)],this.buttonWrapperDiv.show()),this.cropInfo.startPoint=void 0}}cancelCrop(){this.buttonWrapperDiv.hide(),this.viewer.setMouseNavEnabled(!0),this.sk.noLoop(),this.sk.cursor(this.sk.ARROW),this.cropInfo={}}doCrop(){if(this.cropInfo.enable){this.cropInfo.seaDragonImage&&this.sk.image(this.cropInfo.seaDragonImage,0,0,this.sk.width,this.sk.height),this.sk.image(this.cropInfo.prevCanvasImage,0,0,this.sk.width,this.sk.height);const e=this.cropInfo.startPoint,t=new c.exports.Point(this.sk.mouseX,this.sk.mouseY);this.cropInfo.onWhere||this.sk.cursor(this.sk.CROSS),e&&this.drawQuad(e,t),this.cropInfo.currentSelected&&(this.drawQuad(...this.cropInfo.currentSelected),this.transformQuad(...this.cropInfo.currentSelected))}}drawQuad(e,t){if(e&&"globalCompositeOperation"in this.pg.drawingContext){const s=[new c.exports.Point(e.x,e.y),new c.exports.Point(t.x,e.y),new c.exports.Point(t.x,t.y),new c.exports.Point(e.x,t.y)];this.pg.clear(),this.pg.background(0,0,0,120),this.pg.push(),this.pg.drawingContext.globalCompositeOperation="destination-out",this.pg.fill(255,255,255,255),this.pg.quad(s[0].x,s[0].y,s[1].x,s[1].y,s[2].x,s[2].y,s[3].x,s[3].y),this.pg.pop(),this.pg.push(),this.pg.noFill(),this.pg.stroke(0,0,255),this.pg.strokeWeight(2),this.pg.quad(s[0].x,s[0].y,s[1].x,s[1].y,s[2].x,s[2].y,s[3].x,s[3].y),s.forEach(i=>{this.pg.fill(0,0,255),this.pg.square(i.x-C,i.y-C,h)}),this.pg.pop(),this.sk.image(this.pg,0,0,this.sk.width,this.sk.height)}}transformQuad(e,t){var I;if(!e)return!1;const s=new c.exports.Point(this.sk.mouseX,this.sk.mouseY),{mainRect:i,leftRect:r,rightRect:a,bottomRect:p,topRect:y,topLeftRect:u,topRightRect:v,bottomLeftRect:k,bottomRightRect:l,topLeftPoint:f}=L.getRectFromPoint(e,t);if(this.buttonWrapperDiv.position(f.x,f.y-ce),this.sk.mouseIsPressed||(this.cropInfo.onWhere=void 0,i.containsPoint(s)&&(this.sk.cursor(this.sk.MOVE),this.cropInfo.onWhere="inside"),[{cursor:"ns-resize",rect:y,onWhere:"top"},{cursor:"ew-resize",rect:a,onWhere:"right"},{cursor:"ns-resize",rect:p,onWhere:"bottom"},{cursor:"ew-resize",rect:r,onWhere:"left"},{cursor:"nwse-resize",rect:u,onWhere:"topLeft"},{cursor:"nesw-resize",rect:v,onWhere:"topRight"},{cursor:"nwse-resize",rect:l,onWhere:"bottomRight"},{cursor:"nesw-resize",rect:k,onWhere:"bottomLeft"}].forEach(({cursor:m,rect:w,onWhere:x})=>{w.containsPoint(s)&&(this.sk.cursor(m),this.cropInfo.onWhere=x)})),this.sk.mouseIsPressed){const m=s.x-this.sk.pmouseX,w=s.y-this.sk.pmouseY;switch(this.cropInfo.onWhere){case"inside":(I=this.cropInfo.currentSelected)==null||I.forEach(x=>{x.x+=m,x.y+=w});break;case"top":this.cropInfo.currentSelected[0].y+=w;break;case"right":this.cropInfo.currentSelected[1].x+=m;break;case"bottom":this.cropInfo.currentSelected[1].y+=w;break;case"left":this.cropInfo.currentSelected[0].x+=m;break;case"topLeft":this.cropInfo.currentSelected[0].x+=m,this.cropInfo.currentSelected[0].y+=w;break;case"topRight":this.cropInfo.currentSelected[1].x+=m,this.cropInfo.currentSelected[0].y+=w;break;case"bottomRight":this.cropInfo.currentSelected[1].x+=m,this.cropInfo.currentSelected[1].y+=w;break;case"bottomLeft":this.cropInfo.currentSelected[0].x+=m,this.cropInfo.currentSelected[1].y+=w;break}}}finish(){const[e,t]=this.cropInfo.currentSelected,{mainInsideRect:s}=L.getRectFromPoint(e,t);this.cropInfo.enable=!1,this.sk.noLoop(),this.sk.clear(),this.cropInfo.seaDragonImage&&this.sk.image(this.cropInfo.seaDragonImage,0,0,this.sk.width,this.sk.height),this.sk.image(this.cropInfo.prevCanvasImage,0,0,this.sk.width,this.sk.height),this.sk.get(s.x,s.y,s.width,s.height).canvas.toBlob(r=>{if(r){const a=URL.createObjectURL(r);this.store.push({blob:r,url:a,key:a}),this.eventSource.emit("cropStoreChange",this.store)}}),this.eventSource.emit("cropFinish",this),this.cancelCrop()}resize(){const e=this.viewer.viewport.getContainerSize();this.pg.resizeCanvas(e.x,e.y)}setStore(e){this.store=e,this.eventSource.emit("cropStoreChange",e)}deleteCropStore(e,t=1){this.store.splice(e,t).forEach(i=>{i.blob&&URL.revokeObjectURL(i.url)}),this.eventSource.emit("cropStoreChange",this.store)}static getRectFromPoint(e,t){const s=new c.exports.Point(Math.min(e.x,t.x),Math.min(e.y,t.y)),i=new c.exports.Point(Math.max(e.x,t.x),Math.max(e.y,t.y)),r=new c.exports.Point(s.x-C,s.y-C),a=new c.exports.Point(i.x+C,i.y+C),p=a.x-r.x,y=i.x-s.x,u=a.y-r.y,v=i.y-s.y,k=new c.exports.Rect(r.x,r.y,p,u),l=new c.exports.Rect(s.x,s.y,y,v),f=new c.exports.Rect(r.x,r.y,p,h),I=new c.exports.Rect(a.x-h,r.y,h,u),m=new c.exports.Rect(r.x,a.y-h,p,h),w=new c.exports.Rect(r.x,r.y,h,u),x=new c.exports.Rect(r.x,r.y,h,h),S=new c.exports.Rect(a.x-h,r.y,h,h),B=new c.exports.Rect(r.x,a.y-h,h,h),H=new c.exports.Rect(a.x-h,a.y-h,h,h);return{mainRect:k,topRect:f,topLeftPoint:r,rightRect:I,bottomRect:m,leftRect:w,topLeftRect:x,topRightRect:S,bottomLeftRect:B,bottomRightRect:H,mainInsideRect:l}}}class he{constructor(e){d(this,"overlay");d(this,"drawOptions");d(this,"sk");d(this,"store");this.overlay=e,this.drawOptions={},this.sk=e.sk,this.store=[]}startDraw(e){this.overlay.crop.cancelCrop(),this.drawOptions.enable=!0,this.overlay.viewer.setMouseNavEnabled(!1),this.drawOptions.startPoint=null,this.drawOptions.endPoint=null,this.drawOptions.startPointTransformed=null,this.drawOptions.freePath=[],this.sk.loop(),this.sk.mousePressed=()=>{var t;if(this.drawOptions.startPoint=new c.exports.Point(this.sk.mouseX,this.sk.mouseY),((t=this.drawOptions)==null?void 0:t.type)==="text"){const s=this.sk.select("#inputWrap");s?(s==null||s.position(this.drawOptions.startPoint.x,this.drawOptions.startPoint.y),e==null||e()):console.error("inputWrap is null")}},this.sk.mouseReleased=()=>{var s,i;if(((s=this.drawOptions)==null?void 0:s.type)==="text")return this.sk.mousePressed=R.noop,!1;this.drawOptions.enable=!1,this.sk.noLoop(),this.overlay.viewer.setMouseNavEnabled(!0),this.sk.mousePressed=R.noop;const t=E({},this.drawOptions);switch((i=this.drawOptions)==null?void 0:i.type){case"circle":case"rect":case"line":t.path=[[this.drawOptions.startPointTransformed.x,this.drawOptions.startPointTransformed.y],[this.drawOptions.endPoint.x,this.drawOptions.endPoint.y]];break;case"free":t.path=this.drawOptions.freePath;break}this.store.push(t),this.drawOptions={},this.sk.mouseReleased=R.noop}}drawMarkStore(e){this.store.forEach(t=>{this.draw(this.sk,t,2,e)})}draw(e,t,s,i,r){var p,y,u,v;if(s===1?t.enable&&e.mouseIsPressed&&t&&t.startPoint&&e.mouseButton===e.LEFT:!0){e.push();const k=e.color(t.color);k.setAlpha(e.map(t.opacity,0,1,0,255)),t.startPointTransformed=r==null?void 0:r.viewerElementToImageCoordinates(t.startPoint),t.endPoint=r==null?void 0:r.viewerElementToImageCoordinates(new c.exports.Point(e.mouseX,e.mouseY));let l,f;const I=t.strokeWeight*this.overlay.viewer.viewport.getMinZoom()/this.overlay.viewer.viewport.getHomeZoom();switch(s===1?(l=t.startPointTransformed,f=t.endPoint):(l=new c.exports.Point(...t.path[0]),f=new c.exports.Point(...((p=t.path)==null?void 0:p[1])||[0,0])),["circle","rect","line","free"].includes(t.type)&&(e.noFill(),e.strokeWeight(I*2),e.stroke(k)),t==null?void 0:t.type){case"circle":e.circle(l.x,l.y,l.distanceTo(f)*2);break;case"rect":e.quad(l.x,l.y,f.x,l.y,f.x,f.y,l.x,f.y);break;case"line":e.line(l.x,l.y,f.x,f.y);break;case"free":s==1&&(((y=t.freePath)==null?void 0:y.length)===0&&t.freePath.push([l.x,l.y]),new c.exports.Point(...R.last(t.freePath)).distanceTo(f)>20&&((u=t.freePath)==null||u.push([f.x,f.y]))),(v=t[s===1?"freePath":"path"])==null||v.forEach((m,w)=>{var S;const x=(S=t.freePath)==null?void 0:S[w+1];x&&e.line(...m,...x)});break;case"text":(s===1?t.isInputOk:!0)&&(e.textSize(I*25),e.fill(k),e.text(t.text,l.x,l.y));break}e.pop()}}setDrawOptions(e){this.drawOptions=e}setStore(e){this.store=e,this.overlay.redraw()}}class le{constructor(e){d(this,"viewer");d(this,"wrapDiv");d(this,"sk");d(this,"crop");d(this,"overlayEvent");d(this,"drawMarker");this.overlayEvent=new Q.exports.EventEmitter,this.viewer=e,this.wrapDiv=document.createElement("div"),this.wrapDiv.classList.add("p5-wrap"),this.viewer.canvas.append(this.wrapDiv),this.sk=new Z(t=>{this.sk=t,this.drawMarker=new he(this),t.setup=()=>{const s=this.viewer.viewport.getContainerSize();t.createCanvas(s.x,s.y),t.noLoop()},t.draw=()=>{let s=this.viewer.viewport.getZoom(!0);t.clear();for(let i=0,r=this.viewer.world.getItemCount();i<r;i++){let a=this.viewer.world.getItemAt(i);if(a){let p=a.viewportToImageZoom(s),y=a.imageToViewportCoordinates(0,0,!0),u=this.viewer.viewport.pixelFromPoint(y,!0);this.crop.cropInfo.enable||(t.push(),t.translate(u.x,u.y),t.scale(p,p),this.drawMarker.drawMarkStore(s),this.drawMarker.draw(t,this.drawMarker.drawOptions,1,s,a),t.pop()),this.crop.doCrop()}}}},this.wrapDiv),this.crop=new L(this),this.viewer.addHandler("open",this.redraw.bind(this)),this.viewer.addHandler("update-viewport",this.redraw.bind(this)),this.viewer.addHandler("resize",this.resizeCanvas.bind(this))}resizeCanvas(){var t,s;const e=this.viewer.viewport.getContainerSize();(t=this.sk)==null||t.resizeCanvas(e.x,e.y,!1),(s=this.crop)==null||s.resize()}redraw(){var e;(e=this.sk)==null||e.redraw()}}const pe=({options:n,controlPanel:e})=>{const[t,s]=P.exports.useState(),i=e||(()=>null),r=N({controlPanelOk:!1}),a=P.exports.useRef(null),p=P.exports.useRef(document.createElement("div")),y=q(u=>{u.container.append(p.current),r.controlPanelOk=!0});return P.exports.useEffect(()=>{let u;if(a.current){u=$(E({element:a.current},n));const v=new le(u);s(v),y(u),R.set(window,"overlay",v)}return()=>{u.destroy()}},[a.current,n]),g("div",{children:[o("div",{className:"h-100vh w-full z-1",ref:a}),r.controlPanelOk&&t&&A.exports.createPortal(o(i,{overlay:t}),p.current)]})},ue=[{type:"circle",label:"\u5706\u5F62"},{type:"rect",label:"\u77E9\u5F62"},{type:"line",label:"\u76F4\u7EBF"},{type:"free",label:"\u81EA\u7531"},{type:"text",label:"\u6587\u5B57"}],de=({onChange:n})=>{const e=N({strokeWeight:10,opacity:1,color:"#3f51b5",type:null});return g("div",{className:"w-230px space-y-4",children:[g("div",{children:[o("p",{children:"\u753B\u7B14\u7C97\u7EC6\uFF1A"}),o(M,{min:10,max:100,onChange:t=>{e.strokeWeight=t}})]}),g("div",{children:[o("p",{children:"\u900F\u660E\u5EA6\uFF1A"}),o(M,{min:.1,max:1,step:.1,defaultValue:1,onChange:t=>{e.opacity=t}})]}),g("div",{children:[o("p",{children:"\u989C\u8272\uFF1A"}),o(G,{onChange:t=>{e.color=t.hex}})]}),g("div",{children:[o("p",{children:"\u7C7B\u578B\uFF1A"}),o("div",{className:"grid grid-cols-3 gap-1",children:ue.map(({type:t,label:s})=>o(b,{onClick:()=>{e.type=t,n==null||n(e)},children:s},t))})]})]})},fe=({value:n,onDelete:e})=>(n==null?void 0:n.length)===0?o(K,{className:"w-240px !m-0"}):o(J,{className:"w-240px",data:n||[],itemKey:"key",itemHeight:116,height:((n==null?void 0:n.length)||0)>3?3*116:void 0,children:(t,s)=>g("div",{className:"py-2 flex",children:[o(ee,{width:200,height:100,src:t.url,preview:{maskStyle:{zIndex:1100},wrapStyle:{zIndex:1100}}}),o(b,{className:"ml-auto",danger:!0,type:"primary",shape:"circle",icon:o(te,{}),onClick:()=>{e==null||e(s)}})]})}),{Item:F}=V,me=[{type:"fullscreen",label:"\u5168\u5C4F"},{type:"home",label:"\u4E3B\u9875"}],we=({overlay:n})=>{const{sk:e,viewer:t,drawMarker:s}=n,{drawOptions:i}=s,r=N({markVisibility:!1,inputVisibility:!1,cropVisibility:!1,cropList:[],inputText:""});return P.exports.useEffect(()=>{const a=p=>{r.cropList=p};return n.overlayEvent.on("cropStoreChange",a),()=>{n.overlayEvent.off("cropStoreChange",a)}},[n]),e?g(z,{children:[o(W,{zIndex:10,visible:r.inputVisibility,content:g("div",{className:"space-y-4 w-300px",children:[o(se,{autoFocus:!0,value:r.inputText,onChange:a=>{r.inputText=a.target.value}}),g("div",{className:"flex",children:[o(b,{onClick:()=>{r.inputVisibility=!1,r.inputText="",e.noLoop(),t.setMouseNavEnabled(!0),i.enable=!1},children:"\u53D6\u6D88"}),o(b,{type:"primary",className:"ml-auto",onClick:()=>{r.inputVisibility=!1,i.isInputOk=!0,s.store.push(O(E({},i),{path:[[i.startPointTransformed.x,i.startPointTransformed.y]],text:r.inputText})),e.noLoop(),t.setMouseNavEnabled(!0),r.inputText="",i.enable=!1},children:"\u786E\u8BA4"})]})]}),children:o("div",{id:"inputWrap"})}),o("div",{className:"absolute right-0 w-100px",children:g(V,{mode:"inline",className:"border border-color-[#dedede] shadow",children:[me.map(({type:a,label:p})=>o(F,{onClick:({key:y})=>{switch(y){case"fullscreen":t.setFullScreen(!0);break;case"home":t.viewport.goHome(!0);break}},children:p},a)),o(F,{style:{paddingLeft:24},children:o("div",{className:"absolute top-0 right-0 bottom-0 left-0 flex items-center",children:o(W,{className:"pl-24px",placement:"leftTop",title:o("p",{children:"\u6807\u6CE8"}),content:o(de,{onChange:a=>{r.markVisibility=!1,s.setDrawOptions(a),s.startDraw(()=>{r.inputVisibility=!0})}}),trigger:"click",visible:r.markVisibility,children:o("a",{onClick:()=>{r.markVisibility=!r.markVisibility,r.cropVisibility=!1},children:"\u6807\u6CE8"})})})},"mark"),o(F,{style:{paddingLeft:24},children:o("div",{className:"absolute top-0 right-0 bottom-0 left-0 flex items-center",children:o(W,{className:"pl-24px",placement:"leftTop",style:{zIndex:1e3},title:g(z,{children:[o(b,{type:"primary",size:"small",onClick:()=>{n.crop.startCrop(),r.cropVisibility=!1},children:"\u5F00\u59CB"}),o(b,{type:"primary",size:"small",danger:!0,className:"ml-4",onClick:()=>{r.cropVisibility=!1,n.crop.cancelCrop()},children:"\u53D6\u6D88"})]}),content:o(fe,{value:r.cropList,onDelete:n.crop.deleteCropStore.bind(n.crop)}),visible:r.cropVisibility,children:o("a",{onClick:()=>{r.markVisibility=!1,r.cropVisibility=!r.cropVisibility},children:"\u88C1\u526A"})})})},"crop")]})})]}):null};function ge(){const n=P.exports.useRef(new c.exports.TileSource({width:7026,height:9221,tileSize:256,tileOverlap:2,getTileUrl(e,t,s){return`//openseadragon.github.io//example-images/highsmith/highsmith_files/${e}/${t}_${s}.jpg`}}));return o(pe,{options:{crossOriginPolicy:"Anonymous",showNavigationControl:!1,showNavigator:!0,navigatorAutoFade:!1,navigatorAutoResize:!1,navigatorHeight:100,navigatorWidth:200,navigatorPosition:"TOP_LEFT",tileSources:[n.current],gestureSettingsMouse:{dblClickToZoom:!1,clickToZoom:!1}},controlPanel:we})}re.render(o(ie.StrictMode,{children:o(oe,{locale:ne,children:o(ge,{})})}),document.getElementById("root"));
