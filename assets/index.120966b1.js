var U=Object.defineProperty,Y=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;var F=(n,e,s)=>e in n?U(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s,z=(n,e)=>{for(var s in e||(e={}))X.call(e,s)&&F(n,s,e[s]);if(T)for(var s of T(e))_.call(e,s)&&F(n,s,e[s]);return n},A=(n,e)=>Y(n,j(e));var u=(n,e,s)=>(F(n,typeof e!="symbol"?e+"":e,s),s);import{u as O,j as m,a as o,S as V,C as Q,B as b,L as Z,I as q,r as P,F as D,P as W,b as $,M as B,c as H,o as c,e as G,_ as S,d as K,O as J,R as ee,f as te}from"./vendor.b5551291.js";const re=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))t(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function s(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(i){if(i.ep)return;i.ep=!0;const r=s(i);fetch(i.href,r)}};re();const ie=[{type:"circle",label:"\u5706\u5F62"},{type:"rect",label:"\u77E9\u5F62"},{type:"line",label:"\u76F4\u7EBF"},{type:"free",label:"\u81EA\u7531"},{type:"text",label:"\u6587\u5B57"}],se=({onChange:n})=>{const e=O({strokeWeight:10,opacity:1,color:"#3f51b5",type:null});return m("div",{className:"w-230px space-y-4",children:[m("div",{children:[o("p",{children:"\u753B\u7B14\u7C97\u7EC6\uFF1A"}),o(V,{min:10,max:100,onChange:s=>{e.strokeWeight=s}})]}),m("div",{children:[o("p",{children:"\u900F\u660E\u5EA6\uFF1A"}),o(V,{min:.1,max:1,step:.1,defaultValue:1,onChange:s=>{e.opacity=s}})]}),m("div",{children:[o("p",{children:"\u989C\u8272\uFF1A"}),o(Q,{onChange:s=>{e.color=s.hex}})]}),m("div",{children:[o("p",{children:"\u7C7B\u578B\uFF1A"}),o("div",{className:"grid grid-cols-3 gap-1",children:ie.map(({type:s,label:t})=>o(b,{onClick:()=>{e.type=s,n==null||n(e)},children:t},s))})]})]})},oe=({value:n})=>o(Z,{className:"w-200px",data:n||[],itemKey:"key",itemHeight:116,height:((n==null?void 0:n.length)||0)>3?3*116:void 0,children:e=>o("div",{className:"py-2 w-200px",children:o(q,{width:200,height:100,src:e.url,preview:{maskStyle:{zIndex:1100},wrapStyle:{zIndex:1100}}})})}),{Item:N}=B,ne=[{type:"fullscreen",label:"\u5168\u5C4F"},{type:"home",label:"\u4E3B\u9875"}],ae=({overlay:n})=>{const{sk:e,viewer:s,drawMethod:t,markerStore:i}=n,r=O({markVisibility:!1,inputVisibility:!1,cropVisibility:!1,cropList:[],inputText:""});return P.exports.useEffect(()=>{const a=h=>{r.cropList=h};return n.overlayEvent.on("cropStoreChange",a),()=>{n.overlayEvent.off("cropStoreChange",a)}},[]),e?m(D,{children:[o(W,{zIndex:10,visible:r.inputVisibility,content:m("div",{className:"space-y-4 w-300px",children:[o($,{autoFocus:!0,value:r.inputText,onChange:a=>{r.inputText=a.target.value}}),m("div",{className:"flex",children:[o(b,{onClick:()=>{r.inputVisibility=!1,r.inputText="",e.noLoop(),s.setMouseNavEnabled(!0),t.drawOptions.enable=!1},children:"\u53D6\u6D88"}),o(b,{type:"primary",className:"ml-auto",onClick:()=>{r.inputVisibility=!1,t.drawOptions.isInputOk=!0,i.push(A(z({},t.drawOptions),{path:[[t.drawOptions.startPointTransformed.x,t.drawOptions.startPointTransformed.y]],text:r.inputText})),e.noLoop(),s.setMouseNavEnabled(!0),r.inputText="",t.drawOptions.enable=!1},children:"\u786E\u8BA4"})]})]}),children:o("div",{id:"inputWrap"})}),o("div",{className:"absolute right-0 w-100px",children:m(B,{mode:"inline",className:"border border-color-[#dedede] shadow",children:[ne.map(({type:a,label:h})=>o(N,{onClick:({key:g})=>{switch(g){case"fullscreen":s.setFullScreen(!0);break;case"home":s.viewport.goHome(!0);break}},children:h},a)),o(N,{style:{paddingLeft:24},children:o("div",{className:"absolute top-0 right-0 bottom-0 left-0 flex items-center",children:o(W,{className:"pl-24px",placement:"leftTop",title:o("p",{children:"\u6807\u6CE8"}),content:o(se,{onChange:a=>{r.markVisibility=!1,t.drawOptions=a,t.startDraw(()=>{r.inputVisibility=!0})}}),trigger:"click",visible:r.markVisibility,children:o("a",{onClick:()=>{r.markVisibility=!r.markVisibility,r.cropVisibility=!1},children:"\u6807\u6CE8"})})})},"mark"),o(N,{style:{paddingLeft:24},children:o("div",{className:"absolute top-0 right-0 bottom-0 left-0 flex items-center",children:o(W,{className:"pl-24px",placement:"leftTop",style:{zIndex:1e3},title:m(D,{children:[o(b,{type:"primary",size:"small",onClick:()=>{n.crop.startCrop(),r.cropVisibility=!1},children:"\u5F00\u59CB"}),o(b,{type:"primary",size:"small",danger:!0,className:"ml-4",onClick:()=>{r.cropVisibility=!1,n.crop.cancelCrop()},children:"\u53D6\u6D88"})]}),content:o(oe,{value:r.cropList}),visible:r.cropVisibility,children:o("a",{onClick:()=>{r.markVisibility=!1,r.cropVisibility=!r.cropVisibility},children:"\u88C1\u526A"})})})},"crop")]})})]}):null},d=8,C=d/2,ce=34;class M{constructor(e){u(this,"viewer");u(this,"sk");u(this,"cropInfo",{});u(this,"buttonWrapperDiv");u(this,"pg");u(this,"onFinish");this.onFinish=e.onCropFinish,this.viewer=e.viewer,this.sk=e.sk,this.buttonWrapperDiv=this.sk.createDiv(),this.buttonWrapperDiv.hide(),this.buttonWrapperDiv.addClass("w-120px");const s=this.viewer.viewport.getContainerSize();this.pg=this.sk.createGraphics(s.x,s.y),H.exports.render(m(D,{children:[o(b,{size:"small",type:"primary",onClick:()=>{this.finish()},children:"\u786E\u5B9A"}),o(b,{className:"ml-4",size:"small",danger:!0,type:"primary",onClick:()=>{this.cancelCrop()},children:"\u53D6\u6D88"})]}),this.buttonWrapperDiv.elt),this.viewer.container.append(this.buttonWrapperDiv.elt)}startCrop(){if(this.cropInfo.enable)return!1;this.cropInfo.prevCanvasImage=this.sk.get(),this.viewer.setMouseNavEnabled(!1),this.viewer.drawer.canvas.toBlob(e=>{if(e){const s=URL.createObjectURL(e);this.sk.loadImage(s,t=>{this.cropInfo.seaDragonImage=t,URL.revokeObjectURL(s)})}}),this.sk.loop(),this.cropInfo.enable=!0,this.sk.mousePressed=e=>(!this.cropInfo.enable||e.target.nodeName!=="CANVAS"||this.cropInfo.onWhere||(this.cropInfo.startPoint=new c.exports.Point(this.sk.mouseX,this.sk.mouseY),this.cropInfo.currentSelected=void 0),!1),this.sk.mouseReleased=e=>{if(!this.cropInfo.enable||e.target.nodeName!=="CANVAS")return!1;this.cropInfo.currentSelected||(this.cropInfo.currentSelected=[this.cropInfo.startPoint,new c.exports.Point(this.sk.mouseX,this.sk.mouseY)],this.buttonWrapperDiv.show()),this.cropInfo.startPoint=void 0}}cancelCrop(){this.buttonWrapperDiv.hide(),this.viewer.setMouseNavEnabled(!0),this.sk.noLoop(),this.sk.cursor(this.sk.ARROW),this.cropInfo={}}doCrop(){if(this.cropInfo.enable){this.cropInfo.seaDragonImage&&this.sk.image(this.cropInfo.seaDragonImage,0,0,this.sk.width,this.sk.height),this.sk.image(this.cropInfo.prevCanvasImage,0,0,this.sk.width,this.sk.height);const e=this.cropInfo.startPoint,s=new c.exports.Point(this.sk.mouseX,this.sk.mouseY);this.cropInfo.onWhere||this.sk.cursor(this.sk.CROSS),e&&this.drawQuad(e,s),this.cropInfo.currentSelected&&(this.drawQuad(...this.cropInfo.currentSelected),this.transformQuad(...this.cropInfo.currentSelected))}}drawQuad(e,s){if(e&&"globalCompositeOperation"in this.pg.drawingContext){const t=[new c.exports.Point(e.x,e.y),new c.exports.Point(s.x,e.y),new c.exports.Point(s.x,s.y),new c.exports.Point(e.x,s.y)];this.pg.clear(),this.pg.background(0,0,0,120),this.pg.push(),this.pg.drawingContext.globalCompositeOperation="destination-out",this.pg.fill(255,255,255,255),this.pg.quad(t[0].x,t[0].y,t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y),this.pg.pop(),this.pg.push(),this.pg.noFill(),this.pg.stroke(0,0,255),this.pg.strokeWeight(2),this.pg.quad(t[0].x,t[0].y,t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y),t.forEach(i=>{this.pg.fill(0,0,255),this.pg.square(i.x-C,i.y-C,d)}),this.pg.pop(),this.sk.image(this.pg,0,0,this.sk.width,this.sk.height)}}transformQuad(e,s){var p;if(!e)return!1;const t=new c.exports.Point(this.sk.mouseX,this.sk.mouseY),{mainRect:i,leftRect:r,rightRect:a,bottomRect:h,topRect:g,topLeftRect:w,topRightRect:y,bottomLeftRect:k,bottomRightRect:I,topLeftPoint:x}=M.getRectFromPoint(e,s);if(this.buttonWrapperDiv.position(x.x,x.y-ce),this.sk.mouseIsPressed||(this.cropInfo.onWhere=void 0,i.containsPoint(t)&&(this.sk.cursor(this.sk.MOVE),this.cropInfo.onWhere="inside"),[{cursor:"ns-resize",rect:g,onWhere:"top"},{cursor:"ew-resize",rect:a,onWhere:"right"},{cursor:"ns-resize",rect:h,onWhere:"bottom"},{cursor:"ew-resize",rect:r,onWhere:"left"},{cursor:"nwse-resize",rect:w,onWhere:"topLeft"},{cursor:"nesw-resize",rect:y,onWhere:"topRight"},{cursor:"nwse-resize",rect:I,onWhere:"bottomRight"},{cursor:"nesw-resize",rect:k,onWhere:"bottomLeft"}].forEach(({cursor:l,rect:f,onWhere:v})=>{f.containsPoint(t)&&(this.sk.cursor(l),this.cropInfo.onWhere=v)})),this.sk.mouseIsPressed){const l=t.x-this.sk.pmouseX,f=t.y-this.sk.pmouseY;switch(this.cropInfo.onWhere){case"inside":(p=this.cropInfo.currentSelected)==null||p.forEach(v=>{v.x+=l,v.y+=f});break;case"top":this.cropInfo.currentSelected[0].y+=f;break;case"right":this.cropInfo.currentSelected[1].x+=l;break;case"bottom":this.cropInfo.currentSelected[1].y+=f;break;case"left":this.cropInfo.currentSelected[0].x+=l;break;case"topLeft":this.cropInfo.currentSelected[0].x+=l,this.cropInfo.currentSelected[0].y+=f;break;case"topRight":this.cropInfo.currentSelected[1].x+=l,this.cropInfo.currentSelected[0].y+=f;break;case"bottomRight":this.cropInfo.currentSelected[1].x+=l,this.cropInfo.currentSelected[1].y+=f;break;case"bottomLeft":this.cropInfo.currentSelected[0].x+=l,this.cropInfo.currentSelected[1].y+=f;break}}}finish(){const[e,s]=this.cropInfo.currentSelected,{mainInsideRect:t}=M.getRectFromPoint(e,s);this.cropInfo.enable=!1,this.sk.noLoop(),this.sk.clear(),this.cropInfo.seaDragonImage&&this.sk.image(this.cropInfo.seaDragonImage,0,0,this.sk.width,this.sk.height),this.sk.image(this.cropInfo.prevCanvasImage,0,0,this.sk.width,this.sk.height),this.sk.get(t.x,t.y,t.width,t.height).canvas.toBlob(r=>{var a;if(r){const h=URL.createObjectURL(r);(a=this.onFinish)==null||a.call(this,{blob:r,url:h,key:h})}}),this.cancelCrop()}resize(){const e=this.viewer.viewport.getContainerSize();this.pg.resizeCanvas(e.x,e.y)}static getRectFromPoint(e,s){const t=new c.exports.Point(Math.min(e.x,s.x),Math.min(e.y,s.y)),i=new c.exports.Point(Math.max(e.x,s.x),Math.max(e.y,s.y)),r=new c.exports.Point(t.x-C,t.y-C),a=new c.exports.Point(i.x+C,i.y+C),h=a.x-r.x,g=i.x-t.x,w=a.y-r.y,y=i.y-t.y,k=new c.exports.Rect(r.x,r.y,h,w),I=new c.exports.Rect(t.x,t.y,g,y),x=new c.exports.Rect(r.x,r.y,h,d),p=new c.exports.Rect(a.x-d,r.y,d,w),l=new c.exports.Rect(r.x,a.y-d,h,d),f=new c.exports.Rect(r.x,r.y,d,w),v=new c.exports.Rect(r.x,r.y,d,d),L=new c.exports.Rect(a.x-d,r.y,d,d),R=new c.exports.Rect(r.x,a.y-d,d,d),E=new c.exports.Rect(a.x-d,a.y-d,d,d);return{mainRect:k,topRect:x,topLeftPoint:r,rightRect:p,bottomRect:l,leftRect:f,topLeftRect:v,topRightRect:L,bottomLeftRect:R,bottomRightRect:E,mainInsideRect:I}}}class he{constructor(e,s){u(this,"viewer");u(this,"wrapDiv");u(this,"sk");u(this,"drawMethod");u(this,"markerStore");u(this,"ControlPanel");u(this,"crop");u(this,"onCropFinish");u(this,"cropStore");u(this,"overlayEvent");this.overlayEvent=new G.exports.EventEmitter,this.cropStore=s.cropStore||[],this.onCropFinish=s.onCropFinish||this.defaultCropFinish.bind(this),this.ControlPanel=s.ControlPanel||ae,this.markerStore=s.markerStore||[],this.viewer=e,this.wrapDiv=document.createElement("div"),this.wrapDiv.classList.add("p5-wrap"),this.viewer.canvas.append(this.wrapDiv),this.drawMethod={drawOptions:{},startDraw:t=>{this.crop.cancelCrop(),this.drawMethod.drawOptions.enable=!0,e.setMouseNavEnabled(!1),this.drawMethod.drawOptions.startPoint=null,this.drawMethod.drawOptions.endPoint=null,this.drawMethod.drawOptions.startPointTransformed=null,this.drawMethod.drawOptions.freePath=[],this.sk.loop(),this.sk.mousePressed=()=>{var i;if(this.drawMethod.drawOptions.startPoint=new c.exports.Point(this.sk.mouseX,this.sk.mouseY),((i=this.drawMethod.drawOptions)==null?void 0:i.type)==="text"){const r=this.sk.select("#inputWrap");r?(r==null||r.position(this.drawMethod.drawOptions.startPoint.x,this.drawMethod.drawOptions.startPoint.y),t==null||t()):console.error("inputWrap is null")}},this.sk.mouseReleased=()=>{var r,a;if(((r=this.drawMethod.drawOptions)==null?void 0:r.type)==="text")return this.sk.mousePressed=S.noop,!1;this.drawMethod.drawOptions.enable=!1,this.sk.noLoop(),e.setMouseNavEnabled(!0),this.sk.mousePressed=S.noop;const i=z({},this.drawMethod.drawOptions);switch((a=this.drawMethod.drawOptions)==null?void 0:a.type){case"circle":case"rect":case"line":i.path=[[this.drawMethod.drawOptions.startPointTransformed.x,this.drawMethod.drawOptions.startPointTransformed.y],[this.drawMethod.drawOptions.endPoint.x,this.drawMethod.drawOptions.endPoint.y]];break;case"free":i.path=this.drawMethod.drawOptions.freePath;break}this.markerStore.push(i),this.drawMethod.drawOptions={},this.sk.mouseReleased=S.noop}},draw:(t,i,r,a,h)=>{var w,y,k,I;if(r===1?i.enable&&t.mouseIsPressed&&i&&i.startPoint&&t.mouseButton===t.LEFT:!0){t.push();const x=t.color(i.color);x.setAlpha(t.map(i.opacity,0,1,0,255)),i.startPointTransformed=h==null?void 0:h.viewerElementToImageCoordinates(i.startPoint),i.endPoint=h==null?void 0:h.viewerElementToImageCoordinates(new c.exports.Point(t.mouseX,t.mouseY));let p,l;const f=i.strokeWeight*e.viewport.getMinZoom()/e.viewport.getHomeZoom();switch(r===1?(p=i.startPointTransformed,l=i.endPoint):(p=new c.exports.Point(...i.path[0]),l=new c.exports.Point(...((w=i.path)==null?void 0:w[1])||[0,0])),["circle","rect","line","free"].includes(i.type)&&(t.noFill(),t.strokeWeight(f*2),t.stroke(x)),i==null?void 0:i.type){case"circle":t.circle(p.x,p.y,p.distanceTo(l)*2);break;case"rect":t.quad(p.x,p.y,l.x,p.y,l.x,l.y,p.x,l.y);break;case"line":t.line(p.x,p.y,l.x,l.y);break;case"free":r==1&&(((y=i.freePath)==null?void 0:y.length)===0&&i.freePath.push([p.x,p.y]),new c.exports.Point(...S.last(i.freePath)).distanceTo(l)>20&&((k=i.freePath)==null||k.push([l.x,l.y]))),(I=i[r===1?"freePath":"path"])==null||I.forEach((v,L)=>{var E;const R=(E=i.freePath)==null?void 0:E[L+1];R&&t.line(...v,...R)});break;case"text":(r===1?i.isInputOk:!0)&&(t.textSize(f*25),t.fill(x),t.text(i.text,p.x,p.y));break}t.pop()}}},this.sk=new K(t=>{t.setup=()=>{const i=this.viewer.viewport.getContainerSize();t.createCanvas(i.x,i.y),t.noLoop(),this.addControl()},t.draw=()=>{let i=this.viewer.viewport.getZoom(!0);t.clear();for(let r=0,a=this.viewer.world.getItemCount();r<a;r++){let h=this.viewer.world.getItemAt(r);if(h){let g=h.viewportToImageZoom(i),w=h.imageToViewportCoordinates(0,0,!0),y=this.viewer.viewport.pixelFromPoint(w,!0);this.crop.cropInfo.enable||(t.push(),t.translate(y.x,y.y),t.scale(g,g),this.drawMarkStore(i),this.drawMethod.draw(t,this.drawMethod.drawOptions,1,i,h),t.pop()),this.crop.doCrop()}}}},this.wrapDiv),this.crop=new M(this),this.viewer.addHandler("open",this.redraw.bind(this)),this.viewer.addHandler("update-viewport",this.redraw.bind(this)),this.viewer.addHandler("resize",this.resizeCanvas.bind(this))}resizeCanvas(){var s,t;const e=this.viewer.viewport.getContainerSize();(s=this.sk)==null||s.resizeCanvas(e.x,e.y,!1),(t=this.crop)==null||t.resize()}redraw(){var e;(e=this.sk)==null||e.redraw()}addControl(){const e=document.createElement("div");this.viewer.container.append(e),setTimeout(()=>{H.exports.render(P.exports.createElement(this.ControlPanel,{overlay:this},null),e)},0)}setMarkStore(e){this.markerStore=e,this.redraw()}drawMarkStore(e){this.markerStore.forEach(s=>{this.drawMethod.draw(this.sk,s,2,e)})}defaultCropFinish(e){this.cropStore.push(e),this.overlayEvent.emit("cropStoreChange",this.cropStore)}setCropStore(e){this.cropStore=e,this.overlayEvent.emit("cropStoreChange",e)}deleteCropStore(e,s=1){this.cropStore.splice(e,s).forEach(i=>{i.blob&&URL.revokeObjectURL(i.url)}),this.overlayEvent.emit("cropStoreChange",this.cropStore)}}function le(){const n=P.exports.useRef(null),e=P.exports.useRef(new c.exports.TileSource({width:7026,height:9221,tileSize:256,tileOverlap:2,getTileUrl(s,t,i){return`//openseadragon.github.io//example-images/highsmith/highsmith_files/${s}/${t}_${i}.jpg`}}));return P.exports.useEffect(()=>{let s;if(n.current){s=J({element:n.current,crossOriginPolicy:"Anonymous",showNavigationControl:!1,showNavigator:!0,navigatorAutoFade:!1,navigatorAutoResize:!1,navigatorHeight:100,navigatorWidth:200,navigatorPosition:"TOP_LEFT",tileSources:[e.current],gestureSettingsMouse:{dblClickToZoom:!1,clickToZoom:!1}});const t=new he(s,{});S.set(window,"overlay",t)}return()=>{s.destroy()}},[n.current]),o("div",{children:o("div",{className:"h-100vh w-full z-1",ref:n})})}ee.render(o(te.StrictMode,{children:o(le,{})}),document.getElementById("root"));
