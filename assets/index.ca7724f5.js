var U=Object.defineProperty,Y=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;var z=(a,e,t)=>e in a?U(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,R=(a,e)=>{for(var t in e||(e={}))X.call(e,t)&&z(a,t,e[t]);if(F)for(var t of F(e))_.call(e,t)&&z(a,t,e[t]);return a},T=(a,e)=>Y(a,j(e));var m=(a,e,t)=>(z(a,typeof e!="symbol"?e+"":e,t),t);import{r as V,j as v,F as N,a as o,B as k,o as l,_ as E,e as Q,P as Z,b as P,u as D,c as q,O as $,S as O,C as G,E as K,L as J,I as ee,D as te,d as se,f as W,g as re,M,R as ie,h as oe,i as ne,z as ae}from"./vendor.10f1a906.js";const ce=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}};ce();const u=8,C=u/2,le=34;class L{constructor(e){m(this,"viewer");m(this,"sk");m(this,"store");m(this,"cropInfo",{});m(this,"buttonWrapperDiv");m(this,"pg");m(this,"eventSource");this.store=[],this.viewer=e.viewer,this.sk=e.sk,this.eventSource=e.overlayEvent,this.buttonWrapperDiv=this.sk.createDiv(),this.buttonWrapperDiv.hide(),this.buttonWrapperDiv.addClass("w-120px");const t=this.viewer.viewport.getContainerSize();this.pg=this.sk.createGraphics(t.x,t.y),V.exports.render(v(N,{children:[o(k,{size:"small",type:"primary",onClick:()=>{this.finish()},children:"\u786E\u5B9A"}),o(k,{className:"ml-4",size:"small",danger:!0,type:"primary",onClick:()=>{this.cancelCrop()},children:"\u53D6\u6D88"})]}),this.buttonWrapperDiv.elt),this.viewer.container.append(this.buttonWrapperDiv.elt)}startCrop(){if(this.cropInfo.enable)return!1;this.cropInfo.prevCanvasImage=this.sk.get(),this.viewer.setMouseNavEnabled(!1),this.viewer.drawer.canvas.toBlob(e=>{if(e){const t=URL.createObjectURL(e);this.sk.loadImage(t,s=>{this.cropInfo.seaDragonImage=s,URL.revokeObjectURL(t)})}}),this.sk.loop(),this.cropInfo.enable=!0,this.sk.mousePressed=e=>(!this.cropInfo.enable||e.target.nodeName!=="CANVAS"||this.cropInfo.onWhere||(this.cropInfo.startPoint=new l.exports.Point(this.sk.mouseX,this.sk.mouseY),this.cropInfo.currentSelected=void 0),!1),this.sk.mouseReleased=e=>{if(!this.cropInfo.enable||e.target.nodeName!=="CANVAS")return!1;this.cropInfo.currentSelected||(this.cropInfo.currentSelected=[this.cropInfo.startPoint,new l.exports.Point(this.sk.mouseX,this.sk.mouseY)],this.buttonWrapperDiv.show()),this.cropInfo.startPoint=void 0}}cancelCrop(){this.buttonWrapperDiv.hide(),this.viewer.setMouseNavEnabled(!0),this.sk.noLoop(),this.sk.cursor(this.sk.ARROW),this.cropInfo={}}doCrop(){if(this.cropInfo.enable){this.cropInfo.seaDragonImage&&this.sk.image(this.cropInfo.seaDragonImage,0,0,this.sk.width,this.sk.height),this.sk.image(this.cropInfo.prevCanvasImage,0,0,this.sk.width,this.sk.height);const e=this.cropInfo.startPoint,t=new l.exports.Point(this.sk.mouseX,this.sk.mouseY);this.cropInfo.onWhere||this.sk.cursor(this.sk.CROSS),e&&this.drawQuad(e,t),this.cropInfo.currentSelected&&(this.drawQuad(...this.cropInfo.currentSelected),this.transformQuad(...this.cropInfo.currentSelected))}}drawQuad(e,t){if(e&&"globalCompositeOperation"in this.pg.drawingContext){const s=[new l.exports.Point(e.x,e.y),new l.exports.Point(t.x,e.y),new l.exports.Point(t.x,t.y),new l.exports.Point(e.x,t.y)];this.pg.clear(),this.pg.background(0,0,0,120),this.pg.push(),this.pg.drawingContext.globalCompositeOperation="destination-out",this.pg.fill(255,255,255,255),this.pg.quad(s[0].x,s[0].y,s[1].x,s[1].y,s[2].x,s[2].y,s[3].x,s[3].y),this.pg.pop(),this.pg.push(),this.pg.noFill(),this.pg.stroke(0,0,255),this.pg.strokeWeight(2),this.pg.quad(s[0].x,s[0].y,s[1].x,s[1].y,s[2].x,s[2].y,s[3].x,s[3].y),s.forEach(i=>{this.pg.fill(0,0,255),this.pg.square(i.x-C,i.y-C,u)}),this.pg.pop(),this.sk.image(this.pg,0,0,this.sk.width,this.sk.height)}}transformQuad(e,t){var I;if(!e)return!1;const s=new l.exports.Point(this.sk.mouseX,this.sk.mouseY),{mainRect:i,leftRect:r,rightRect:c,bottomRect:n,topRect:h,topLeftRect:f,topRightRect:x,bottomLeftRect:g,bottomRightRect:p,topLeftPoint:d}=L.getRectFromPoint(e,t);if(this.buttonWrapperDiv.position(d.x,d.y-le),this.sk.mouseIsPressed||(this.cropInfo.onWhere=void 0,i.containsPoint(s)&&(this.sk.cursor(this.sk.MOVE),this.cropInfo.onWhere="inside"),[{cursor:"ns-resize",rect:h,onWhere:"top"},{cursor:"ew-resize",rect:c,onWhere:"right"},{cursor:"ns-resize",rect:n,onWhere:"bottom"},{cursor:"ew-resize",rect:r,onWhere:"left"},{cursor:"nwse-resize",rect:f,onWhere:"topLeft"},{cursor:"nesw-resize",rect:x,onWhere:"topRight"},{cursor:"nwse-resize",rect:p,onWhere:"bottomRight"},{cursor:"nesw-resize",rect:g,onWhere:"bottomLeft"}].forEach(({cursor:w,rect:y,onWhere:b})=>{y.containsPoint(s)&&(this.sk.cursor(w),this.cropInfo.onWhere=b)})),this.sk.mouseIsPressed){const w=s.x-this.sk.pmouseX,y=s.y-this.sk.pmouseY;switch(this.cropInfo.onWhere){case"inside":(I=this.cropInfo.currentSelected)==null||I.forEach(b=>{b.x+=w,b.y+=y});break;case"top":this.cropInfo.currentSelected[0].y+=y;break;case"right":this.cropInfo.currentSelected[1].x+=w;break;case"bottom":this.cropInfo.currentSelected[1].y+=y;break;case"left":this.cropInfo.currentSelected[0].x+=w;break;case"topLeft":this.cropInfo.currentSelected[0].x+=w,this.cropInfo.currentSelected[0].y+=y;break;case"topRight":this.cropInfo.currentSelected[1].x+=w,this.cropInfo.currentSelected[0].y+=y;break;case"bottomRight":this.cropInfo.currentSelected[1].x+=w,this.cropInfo.currentSelected[1].y+=y;break;case"bottomLeft":this.cropInfo.currentSelected[0].x+=w,this.cropInfo.currentSelected[1].y+=y;break}}}finish(){const[e,t]=this.cropInfo.currentSelected,{mainInsideRect:s}=L.getRectFromPoint(e,t);this.cropInfo.enable=!1,this.sk.noLoop(),this.sk.clear(),this.cropInfo.seaDragonImage&&this.sk.image(this.cropInfo.seaDragonImage,0,0,this.sk.width,this.sk.height),this.sk.image(this.cropInfo.prevCanvasImage,0,0,this.sk.width,this.sk.height),this.sk.get(s.x,s.y,s.width,s.height).canvas.toBlob(r=>{if(r){const c=URL.createObjectURL(r);this.store.push({blob:r,url:c,key:c}),this.eventSource.emit("cropStoreChange",this.store)}}),this.eventSource.emit("cropFinish",this),this.cancelCrop()}resize(){const e=this.viewer.viewport.getContainerSize();this.pg.resizeCanvas(e.x,e.y)}setStore(e){this.store=e,this.eventSource.emit("cropStoreChange",e)}deleteCropStore(e,t=1){this.store.splice(e,t).forEach(i=>{i.blob&&URL.revokeObjectURL(i.url)}),this.eventSource.emit("cropStoreChange",this.store)}static getRectFromPoint(e,t){const s=new l.exports.Point(Math.min(e.x,t.x),Math.min(e.y,t.y)),i=new l.exports.Point(Math.max(e.x,t.x),Math.max(e.y,t.y)),r=new l.exports.Point(s.x-C,s.y-C),c=new l.exports.Point(i.x+C,i.y+C),n=c.x-r.x,h=i.x-s.x,f=c.y-r.y,x=i.y-s.y,g=new l.exports.Rect(r.x,r.y,n,f),p=new l.exports.Rect(s.x,s.y,h,x),d=new l.exports.Rect(r.x,r.y,n,u),I=new l.exports.Rect(c.x-u,r.y,u,f),w=new l.exports.Rect(r.x,c.y-u,n,u),y=new l.exports.Rect(r.x,r.y,u,f),b=new l.exports.Rect(r.x,r.y,u,u),S=new l.exports.Rect(c.x-u,r.y,u,u),B=new l.exports.Rect(r.x,c.y-u,u,u),H=new l.exports.Rect(c.x-u,c.y-u,u,u);return{mainRect:g,topRect:d,topLeftPoint:r,rightRect:I,bottomRect:w,leftRect:y,topLeftRect:b,topRightRect:S,bottomLeftRect:B,bottomRightRect:H,mainInsideRect:p}}}class he{constructor(e){m(this,"overlay");m(this,"drawOptions");m(this,"sk");m(this,"store");this.overlay=e,this.drawOptions={},this.sk=e.sk,this.store=[]}startDraw(e){this.overlay.crop.cancelCrop(),this.drawOptions.enable=!0,this.overlay.viewer.setMouseNavEnabled(!1),this.drawOptions.startPoint=null,this.drawOptions.endPoint=null,this.drawOptions.startPointTransformed=null,this.drawOptions.freePath=[],this.sk.loop(),this.sk.mousePressed=t=>{var s;if(t.target.nodeName!=="CANVAS")return!1;if(this.drawOptions.startPoint=new l.exports.Point(this.sk.mouseX,this.sk.mouseY),((s=this.drawOptions)==null?void 0:s.type)==="text"){const i=this.sk.select("#inputWrap");i?(i==null||i.position(this.drawOptions.startPoint.x,this.drawOptions.startPoint.y),e==null||e()):console.error("inputWrap is null")}},this.sk.mouseReleased=t=>{var i,r;if(t.target.nodeName!=="CANVAS")return!1;if(((i=this.drawOptions)==null?void 0:i.type)==="text")return this.sk.mousePressed=E.noop,!1;this.drawOptions.enable=!1,this.sk.noLoop(),this.overlay.viewer.setMouseNavEnabled(!0),this.sk.mousePressed=E.noop;const s=R({},this.drawOptions);switch((r=this.drawOptions)==null?void 0:r.type){case"circle":case"rect":case"line":s.path=[[this.drawOptions.startPointTransformed.x,this.drawOptions.startPointTransformed.y],[this.drawOptions.endPoint.x,this.drawOptions.endPoint.y]];break;case"free":s.path=this.drawOptions.freePath;break}this.store.push(s),this.drawOptions={},this.sk.mouseReleased=E.noop}}drawMarkStore(e){this.store.forEach(t=>{this.draw(this.sk,t,2,e)})}draw(e,t,s,i,r){var n,h,f,x;if(s===1?t.enable&&e.mouseIsPressed&&t&&t.startPoint&&e.mouseButton===e.LEFT:!0){e.push();const g=e.color(t.color);g.setAlpha(e.map(t.opacity,0,1,0,255)),t.startPointTransformed=r==null?void 0:r.viewerElementToImageCoordinates(t.startPoint),t.endPoint=r==null?void 0:r.viewerElementToImageCoordinates(new l.exports.Point(e.mouseX,e.mouseY));let p,d;const I=t.strokeWeight*this.overlay.viewer.viewport.getMinZoom()/this.overlay.viewer.viewport.getHomeZoom();switch(s===1?(p=t.startPointTransformed,d=t.endPoint):(p=new l.exports.Point(...t.path[0]),d=new l.exports.Point(...((n=t.path)==null?void 0:n[1])||[0,0])),["circle","rect","line","free"].includes(t.type)&&(e.noFill(),e.strokeWeight(I*2),e.stroke(g)),t==null?void 0:t.type){case"circle":e.circle(p.x,p.y,p.distanceTo(d)*2);break;case"rect":e.quad(p.x,p.y,d.x,p.y,d.x,d.y,p.x,d.y);break;case"line":e.line(p.x,p.y,d.x,d.y);break;case"free":s==1&&(((h=t.freePath)==null?void 0:h.length)===0&&t.freePath.push([p.x,p.y]),new l.exports.Point(...E.last(t.freePath)).distanceTo(d)>20&&((f=t.freePath)==null||f.push([d.x,d.y]))),(x=t[s===1?"freePath":"path"])==null||x.forEach((w,y)=>{var S;const b=(S=t.freePath)==null?void 0:S[y+1];b&&e.line(...w,...b)});break;case"text":if(s===1?t.isInputOk:!0){const w=I*20;e.textSize(w),e.fill(g),e.text(t.text,p.x,p.y+w/2)}break}e.pop()}}setDrawOptions(e){this.drawOptions=e}setStore(e){this.store=e,this.overlay.redraw()}}class pe{constructor(e){m(this,"viewer");m(this,"wrapDiv");m(this,"sk");m(this,"crop");m(this,"overlayEvent");m(this,"drawMarker");this.overlayEvent=new Q.exports.EventEmitter,this.viewer=e,this.wrapDiv=document.createElement("div"),this.wrapDiv.classList.add("p5-wrap"),this.viewer.canvas.append(this.wrapDiv),this.sk=new Z(t=>{this.sk=t,this.drawMarker=new he(this),t.setup=()=>{const s=this.viewer.viewport.getContainerSize();t.createCanvas(s.x,s.y),t.noLoop()},t.draw=()=>{let s=this.viewer.viewport.getZoom(!0);t.clear();for(let i=0,r=this.viewer.world.getItemCount();i<r;i++){let c=this.viewer.world.getItemAt(i);if(c){let n=c.viewportToImageZoom(s),h=c.imageToViewportCoordinates(0,0,!0),f=this.viewer.viewport.pixelFromPoint(h,!0);this.crop.cropInfo.enable||(t.push(),t.translate(f.x,f.y),t.scale(n,n),this.drawMarker.drawMarkStore(s),this.drawMarker.draw(t,this.drawMarker.drawOptions,1,s,c),t.pop()),this.crop.doCrop()}}}},this.wrapDiv),this.crop=new L(this),this.viewer.addHandler("open",this.redraw.bind(this)),this.viewer.addHandler("update-viewport",this.redraw.bind(this)),this.viewer.addHandler("resize",this.resizeCanvas.bind(this))}resizeCanvas(){var t,s;const e=this.viewer.viewport.getContainerSize();(t=this.sk)==null||t.resizeCanvas(e.x,e.y,!1),(s=this.crop)==null||s.resize()}redraw(){var e;(e=this.sk)==null||e.redraw()}}const ue=({options:a,controlPanel:e,onReady:t,beforeDeleteCrop:s})=>{const[i,r]=P.exports.useState(),c=e||(()=>null),n=D({controlPanelVisible:!1}),h=P.exports.useRef(null),f=P.exports.useRef(document.createElement("div")),x=q(g=>{g.container.append(f.current),n.controlPanelVisible=!0});return P.exports.useEffect(()=>{let g;if(h.current){g=$(R({element:h.current},a)),g.addHandler("full-screen",d=>{n.controlPanelVisible=!d.fullScreen});const p=new pe(g);r(p),x(g),t==null||t({viewer:g,overlay:p})}return()=>{g.destroy()}},[]),v("div",{children:[o("div",{className:"h-100vh w-full z-1",ref:h}),n.controlPanelVisible&&i&&V.exports.createPortal(o(c,{overlay:i,beforeDeleteCrop:s}),f.current)]})},de=[{type:"circle",label:"\u5706\u5F62"},{type:"rect",label:"\u77E9\u5F62"},{type:"line",label:"\u76F4\u7EBF"},{type:"free",label:"\u81EA\u7531"},{type:"text",label:"\u6587\u5B57"}],fe=({onChange:a})=>{const e=D({strokeWeight:10,opacity:1,color:"#3f51b5",type:null});return v("div",{className:"w-230px space-y-4",children:[v("div",{children:[v("p",{children:["\u753B\u7B14\u7C97\u7EC6\uFF1A",e.strokeWeight]}),o(O,{min:10,max:100,onChange:t=>{e.strokeWeight=t}})]}),v("div",{children:[v("p",{children:["\u900F\u660E\u5EA6\uFF1A",e.opacity]}),o(O,{min:.1,max:1,step:.1,defaultValue:1,onChange:t=>{e.opacity=t}})]}),v("div",{children:[v("p",{children:["\u989C\u8272\uFF1A",o("span",{className:"inline-block w-15px h-15px rounded-100px",style:{backgroundColor:e.color,verticalAlign:-3}})]}),o(G,{onChange:t=>{e.color=t.hex}})]}),v("div",{children:[o("p",{children:"\u7C7B\u578B\uFF1A"}),o("div",{className:"grid grid-cols-3 gap-1",children:de.map(({type:t,label:s})=>o(k,{onClick:()=>{e.type=t,a==null||a(e)},children:s},t))})]})]})},me=({value:a,onDelete:e})=>(a==null?void 0:a.length)===0?o(K,{className:"w-240px !m-0"}):o(J,{className:"w-240px",data:a||[],itemKey:"key",itemHeight:116,height:((a==null?void 0:a.length)||0)>3?3*116:void 0,children:(t,s)=>v("div",{className:"py-2 flex",children:[o(ee,{width:200,height:100,src:t.url,preview:{maskStyle:{zIndex:1100},wrapStyle:{zIndex:1100}}}),o(k,{className:"ml-auto",danger:!0,type:"primary",shape:"circle",icon:o(te,{}),onClick:()=>{e==null||e(s)}})]})}),{Item:A}=M,ge=[{type:"fullscreen",label:"\u5168\u5C4F"},{type:"home",label:"\u4E3B\u9875"}],we=({overlay:a,beforeDeleteCrop:e})=>{const t=se(()=>e||(()=>!0),[e]),{sk:s,viewer:i,drawMarker:r}=a,{drawOptions:c}=r,n=D({markVisibility:!1,inputVisibility:!1,cropVisibility:!1,cropList:[],inputText:""});return P.exports.useEffect(()=>{const h=f=>{n.cropList=f};return a.overlayEvent.on("cropStoreChange",h),()=>{a.overlayEvent.off("cropStoreChange",h)}},[a]),s?v(N,{children:[o(W,{zIndex:10,visible:n.inputVisibility,content:v("div",{className:"space-y-4 w-300px",children:[o(re,{autoFocus:!0,value:n.inputText,onChange:h=>{n.inputText=h.target.value}}),v("div",{className:"flex",children:[o(k,{onClick:()=>{n.inputVisibility=!1,n.inputText="",s.noLoop(),i.setMouseNavEnabled(!0),c.enable=!1},children:"\u53D6\u6D88"}),o(k,{type:"primary",className:"ml-auto",onClick:()=>{n.inputVisibility=!1,c.isInputOk=!0,r.store.push(T(R({},c),{path:[[c.startPointTransformed.x,c.startPointTransformed.y]],text:n.inputText})),s.noLoop(),i.setMouseNavEnabled(!0),n.inputText="",c.enable=!1},children:"\u786E\u8BA4"})]})]}),children:o("div",{id:"inputWrap"})}),o("div",{className:"absolute right-0 w-100px",children:v(M,{mode:"inline",className:"border border-color-[#dedede] shadow",children:[ge.map(({type:h,label:f})=>o(A,{onClick:({key:x})=>{switch(x){case"fullscreen":i.setFullScreen(!0);break;case"home":i.viewport.goHome(!0);break}},children:f},h)),o(A,{style:{paddingLeft:24},children:o("div",{className:"absolute top-0 right-0 bottom-0 left-0 flex items-center",children:o(W,{className:"pl-24px",placement:"leftTop",title:o("p",{children:"\u6807\u6CE8"}),content:o(fe,{onChange:h=>{n.markVisibility=!1,r.setDrawOptions(h),r.startDraw(()=>{n.inputVisibility=!0})}}),trigger:"click",visible:n.markVisibility,children:o("a",{onClick:()=>{n.markVisibility=!n.markVisibility,n.cropVisibility=!1},children:"\u6807\u6CE8"})})})},"mark"),o(A,{style:{paddingLeft:24},children:o("div",{className:"absolute top-0 right-0 bottom-0 left-0 flex items-center",children:o(W,{className:"pl-24px",placement:"leftTop",style:{zIndex:1e3},title:v(N,{children:[o(k,{type:"primary",size:"small",onClick:()=>{a.crop.startCrop(),n.cropVisibility=!1},children:"\u5F00\u59CB"}),o(k,{type:"primary",size:"small",danger:!0,className:"ml-4",onClick:()=>{n.cropVisibility=!1,a.crop.cancelCrop()},children:"\u53D6\u6D88"})]}),content:o(me,{value:n.cropList,onDelete:async h=>{await t(n.cropList[h],h)&&a.crop.deleteCropStore(h)}}),visible:n.cropVisibility,children:o("a",{onClick:()=>{n.markVisibility=!1,n.cropVisibility=!n.cropVisibility},children:"\u88C1\u526A"})})})},"crop")]})})]}):null};function ve(){const a=P.exports.useRef(new l.exports.TileSource({width:7026,height:9221,tileSize:256,tileOverlap:2,getTileUrl(e,t,s){return`//openseadragon.github.io//example-images/highsmith/highsmith_files/${e}/${t}_${s}.jpg`}}));return o(ue,{options:{crossOriginPolicy:"Anonymous",showNavigationControl:!1,showNavigator:!0,navigatorAutoFade:!1,navigatorAutoResize:!1,navigatorHeight:100,navigatorWidth:200,navigatorPosition:"TOP_LEFT",gestureSettingsMouse:{dblClickToZoom:!1,clickToZoom:!1}},controlPanel:we,onReady:({viewer:e})=>{e.open(a.current)}})}ie.render(o(oe.StrictMode,{children:o(ne,{locale:ae,children:o(ve,{})})}),document.getElementById("root"));
