var Y=Object.defineProperty,U=Object.defineProperties;var X=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable;var W=(c,t,i)=>t in c?Y(c,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[t]=i,D=(c,t)=>{for(var i in t||(t={}))_.call(t,i)&&W(c,i,t[i]);if(L)for(var i of L(t))j.call(t,i)&&W(c,i,t[i]);return c},T=(c,t)=>U(c,X(t));var u=(c,t,i)=>(W(c,typeof t!="symbol"?t+"":t,i),i);import{u as A,j as w,a,S as N,C as Q,B as P,F as O,P as B,I as Z,M as V,r as H,o as n,_ as C,b as q,c as M,O as $,R as G,d as K}from"./vendor.cb254ab6.js";const J=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))e(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function i(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(r){if(r.ep)return;r.ep=!0;const s=i(r);fetch(r.href,s)}};J();const ee=[{type:"circle",label:"\u5706\u5F62"},{type:"rect",label:"\u77E9\u5F62"},{type:"line",label:"\u76F4\u7EBF"},{type:"free",label:"\u81EA\u7531"},{type:"text",label:"\u6587\u5B57"}],te=({onChange:c})=>{const t=A({strokeWeight:10,opacity:1,color:"#3f51b5",type:null});return w("div",{className:"w-230px space-y-4",children:[w("div",{children:[a("p",{children:"\u753B\u7B14\u7C97\u7EC6\uFF1A"}),a(N,{min:10,max:100,onChange:i=>{t.strokeWeight=i}})]}),w("div",{children:[a("p",{children:"\u900F\u660E\u5EA6\uFF1A"}),a(N,{min:.1,max:1,step:.1,defaultValue:1,onChange:i=>{t.opacity=i}})]}),w("div",{children:[a("p",{children:"\u989C\u8272\uFF1A"}),a(Q,{onChange:i=>{t.color=i.hex}})]}),w("div",{children:[a("p",{children:"\u7C7B\u578B\uFF1A"}),a("div",{className:"grid grid-cols-3 gap-1",children:ee.map(({type:i,label:e})=>a(P,{onClick:()=>{t.type=i,c==null||c(t)},children:e},i))})]})]})},{Item:z}=V,re=[{type:"fullscreen",label:"\u5168\u5C4F"},{type:"home",label:"\u4E3B\u9875"}],ie=({overlay:c})=>{const{sk:t,viewer:i,drawMethod:e,markerStore:r}=c,s=A({markVisibility:!1,inputVisibility:!1,inputText:""});return t?w(O,{children:[a(B,{zIndex:10,visible:s.inputVisibility,content:w("div",{className:"space-y-4 w-300px",children:[a(Z,{autoFocus:!0,value:s.inputText,onChange:o=>{s.inputText=o.target.value}}),w("div",{className:"flex",children:[a(P,{onClick:()=>{s.inputVisibility=!1,s.inputText="",t.noLoop(),i.setMouseNavEnabled(!0),e.drawOptions.enable=!1},children:"\u53D6\u6D88"}),a(P,{type:"primary",className:"ml-auto",onClick:()=>{s.inputVisibility=!1,e.drawOptions.isInputOk=!0,r.push(T(D({},e.drawOptions),{path:[[e.drawOptions.startPointTransformed.x,e.drawOptions.startPointTransformed.y]],text:s.inputText})),t.noLoop(),i.setMouseNavEnabled(!0),s.inputText="",e.drawOptions.enable=!1},children:"\u786E\u8BA4"})]})]}),children:a("div",{id:"inputWrap"})}),a("div",{className:"absolute right-0 w-100px",children:w(V,{mode:"inline",className:"border border-color-[#dedede] shadow",children:[re.map(({type:o,label:d})=>a(z,{onClick:({key:g})=>{switch(g){case"fullscreen":i.setFullScreen(!0);break;case"home":i.viewport.goHome(!0);break}},children:d},o)),a(B,{placement:"leftTop",title:a("p",{children:"\u6807\u6CE8"}),content:a(te,{onChange:o=>{s.markVisibility=!1,e.drawOptions=o,e.startDraw(()=>{s.inputVisibility=!0})}}),trigger:"click",visible:s.markVisibility,children:a(z,{style:{paddingLeft:24},onClick:()=>{s.markVisibility=!s.markVisibility},children:"\u6807\u6CE8"},"mark")}),a(z,{onClick:()=>{s.markVisibility=!1,c.crop.startCrop()},children:"\u88C1\u526A"},"crop")]})})]}):null},p=8,I=p/2,se=34;class E{constructor(t){u(this,"viewer");u(this,"sk");u(this,"cropInfo",{});u(this,"buttonWrapperDiv");u(this,"pg");u(this,"onFinish");this.onFinish=t.onCropFinish,this.viewer=t.viewer,this.sk=t.sk,this.buttonWrapperDiv=this.sk.createDiv(),this.buttonWrapperDiv.hide(),this.buttonWrapperDiv.addClass("w-120px");const i=this.viewer.viewport.getContainerSize();this.pg=this.sk.createGraphics(i.x,i.y),H.exports.render(w(O,{children:[a(P,{size:"small",type:"primary",onClick:()=>{this.finish()},children:"\u786E\u5B9A"}),a(P,{className:"ml-4",size:"small",danger:!0,type:"primary",onClick:()=>{this.cancelCrop()},children:"\u53D6\u6D88"})]}),this.buttonWrapperDiv.elt),this.viewer.container.append(this.buttonWrapperDiv.elt)}startCrop(){if(this.cropInfo.enable)return!1;this.cropInfo.prevCanvasImage=this.sk.get(),this.viewer.setMouseNavEnabled(!1),this.viewer.drawer.canvas.toBlob(t=>{if(t){const i=URL.createObjectURL(t);this.sk.loadImage(i,e=>{this.cropInfo.seaDragonImage=e,URL.revokeObjectURL(i)})}}),this.sk.loop(),this.cropInfo.enable=!0,this.sk.mousePressed=t=>(!this.cropInfo.enable||t.target.nodeName!=="CANVAS"||this.cropInfo.onWhere||(this.cropInfo.startPoint=new n.exports.Point(this.sk.mouseX,this.sk.mouseY),this.cropInfo.currentSelected=void 0),!1),this.sk.mouseReleased=t=>{if(!this.cropInfo.enable||t.target.nodeName!=="CANVAS")return!1;this.cropInfo.currentSelected||(this.cropInfo.currentSelected=[this.cropInfo.startPoint,new n.exports.Point(this.sk.mouseX,this.sk.mouseY)],this.buttonWrapperDiv.show()),this.cropInfo.startPoint=void 0}}cancelCrop(){this.buttonWrapperDiv.hide(),this.viewer.setMouseNavEnabled(!0),this.sk.noLoop(),this.sk.cursor(this.sk.ARROW),this.cropInfo={}}doCrop(){if(this.cropInfo.enable){this.cropInfo.seaDragonImage&&this.sk.image(this.cropInfo.seaDragonImage,0,0,this.sk.width,this.sk.height),this.sk.image(this.cropInfo.prevCanvasImage,0,0,this.sk.width,this.sk.height);const t=this.cropInfo.startPoint,i=new n.exports.Point(this.sk.mouseX,this.sk.mouseY);this.cropInfo.onWhere||this.sk.cursor(this.sk.CROSS),t&&this.drawQuad(t,i),this.cropInfo.currentSelected&&(this.drawQuad(...this.cropInfo.currentSelected),this.transformQuad(...this.cropInfo.currentSelected))}}drawQuad(t,i){if(t&&"globalCompositeOperation"in this.pg.drawingContext){const e=[new n.exports.Point(t.x,t.y),new n.exports.Point(i.x,t.y),new n.exports.Point(i.x,i.y),new n.exports.Point(t.x,i.y)];this.pg.clear(),this.pg.background(0,0,0,120),this.pg.push(),this.pg.drawingContext.globalCompositeOperation="destination-out",this.pg.fill(255,255,255,255),this.pg.quad(e[0].x,e[0].y,e[1].x,e[1].y,e[2].x,e[2].y,e[3].x,e[3].y),this.pg.pop(),this.pg.push(),this.pg.noFill(),this.pg.stroke(0,0,255),this.pg.strokeWeight(2),this.pg.quad(e[0].x,e[0].y,e[1].x,e[1].y,e[2].x,e[2].y,e[3].x,e[3].y),e.forEach(r=>{this.pg.fill(0,0,255),this.pg.square(r.x-I,r.y-I,p)}),this.pg.pop(),this.sk.image(this.pg,0,0,this.sk.width,this.sk.height)}}transformQuad(t,i){var l;if(!t)return!1;const e=new n.exports.Point(this.sk.mouseX,this.sk.mouseY),{mainRect:r,leftRect:s,rightRect:o,bottomRect:d,topRect:g,topLeftRect:m,topRightRect:x,bottomLeftRect:k,bottomRightRect:b,topLeftPoint:v}=E.getRectFromPoint(t,i);if(this.buttonWrapperDiv.position(v.x,v.y-se),this.sk.mouseIsPressed||(this.cropInfo.onWhere=void 0,r.containsPoint(e)&&(this.sk.cursor(this.sk.MOVE),this.cropInfo.onWhere="inside"),[{cursor:"ns-resize",rect:g,onWhere:"top"},{cursor:"ew-resize",rect:o,onWhere:"right"},{cursor:"ns-resize",rect:d,onWhere:"bottom"},{cursor:"ew-resize",rect:s,onWhere:"left"},{cursor:"nwse-resize",rect:m,onWhere:"topLeft"},{cursor:"nesw-resize",rect:x,onWhere:"topRight"},{cursor:"nwse-resize",rect:b,onWhere:"bottomRight"},{cursor:"nesw-resize",rect:k,onWhere:"bottomLeft"}].forEach(({cursor:h,rect:f,onWhere:y})=>{f.containsPoint(e)&&(this.sk.cursor(h),this.cropInfo.onWhere=y)})),this.sk.mouseIsPressed){const h=e.x-this.sk.pmouseX,f=e.y-this.sk.pmouseY;switch(this.cropInfo.onWhere){case"inside":(l=this.cropInfo.currentSelected)==null||l.forEach(y=>{y.x+=h,y.y+=f});break;case"top":this.cropInfo.currentSelected[0].y+=f;break;case"right":this.cropInfo.currentSelected[1].x+=h;break;case"bottom":this.cropInfo.currentSelected[1].y+=f;break;case"left":this.cropInfo.currentSelected[0].x+=h;break;case"topLeft":this.cropInfo.currentSelected[0].x+=h,this.cropInfo.currentSelected[0].y+=f;break;case"topRight":this.cropInfo.currentSelected[1].x+=h,this.cropInfo.currentSelected[0].y+=f;break;case"bottomRight":this.cropInfo.currentSelected[1].x+=h,this.cropInfo.currentSelected[1].y+=f;break;case"bottomLeft":this.cropInfo.currentSelected[0].x+=h,this.cropInfo.currentSelected[1].y+=f;break}}}finish(){const[t,i]=this.cropInfo.currentSelected,{mainInsideRect:e}=E.getRectFromPoint(t,i);this.cropInfo.enable=!1,this.sk.noLoop(),this.sk.clear(),this.cropInfo.seaDragonImage&&this.sk.image(this.cropInfo.seaDragonImage,0,0,this.sk.width,this.sk.height),this.sk.image(this.cropInfo.prevCanvasImage,0,0,this.sk.width,this.sk.height),this.sk.get(e.x,e.y,e.width,e.height).canvas.toBlob(s=>{var o;s&&((o=this.onFinish)==null||o.call(this,{blob:s}))}),this.cancelCrop()}resize(){const t=this.viewer.viewport.getContainerSize();this.pg.resizeCanvas(t.x,t.y)}static getRectFromPoint(t,i){const e=new n.exports.Point(Math.min(t.x,i.x),Math.min(t.y,i.y)),r=new n.exports.Point(Math.max(t.x,i.x),Math.max(t.y,i.y)),s=new n.exports.Point(e.x-I,e.y-I),o=new n.exports.Point(r.x+I,r.y+I),d=o.x-s.x,g=r.x-e.x,m=o.y-s.y,x=r.y-e.y,k=new n.exports.Rect(s.x,s.y,d,m),b=new n.exports.Rect(e.x,e.y,g,x),v=new n.exports.Rect(s.x,s.y,d,p),l=new n.exports.Rect(o.x-p,s.y,p,m),h=new n.exports.Rect(s.x,o.y-p,d,p),f=new n.exports.Rect(s.x,s.y,p,m),y=new n.exports.Rect(s.x,s.y,p,p),F=new n.exports.Rect(o.x-p,s.y,p,p),R=new n.exports.Rect(s.x,o.y-p,p,p),S=new n.exports.Rect(o.x-p,o.y-p,p,p);return{mainRect:k,topRect:v,topLeftPoint:s,rightRect:l,bottomRect:h,leftRect:f,topLeftRect:y,topRightRect:F,bottomLeftRect:R,bottomRightRect:S,mainInsideRect:b}}}class oe{constructor(t,i){u(this,"viewer");u(this,"wrapDiv");u(this,"sk");u(this,"drawMethod");u(this,"markerStore");u(this,"ControlPanel");u(this,"crop");u(this,"onCropFinish");this.onCropFinish=i.onCropFinish,this.ControlPanel=i.ControlPanel||ie,this.markerStore=i.markerStore||[],this.viewer=t,this.wrapDiv=document.createElement("div"),this.wrapDiv.classList.add("p5-wrap"),this.viewer.canvas.append(this.wrapDiv),this.drawMethod={drawOptions:{},startDraw:e=>{this.crop.cancelCrop(),this.drawMethod.drawOptions.enable=!0,t.setMouseNavEnabled(!1),this.drawMethod.drawOptions.startPoint=null,this.drawMethod.drawOptions.endPoint=null,this.drawMethod.drawOptions.startPointTransformed=null,this.drawMethod.drawOptions.freePath=[],this.sk.loop(),this.sk.mousePressed=()=>{var r;if(this.drawMethod.drawOptions.startPoint=new n.exports.Point(this.sk.mouseX,this.sk.mouseY),((r=this.drawMethod.drawOptions)==null?void 0:r.type)==="text"){const s=this.sk.select("#inputWrap");s?(s==null||s.position(this.drawMethod.drawOptions.startPoint.x,this.drawMethod.drawOptions.startPoint.y),e==null||e()):console.error("inputWrap is null")}},this.sk.mouseReleased=()=>{var s,o;if(((s=this.drawMethod.drawOptions)==null?void 0:s.type)==="text")return this.sk.mousePressed=C.noop,!1;this.drawMethod.drawOptions.enable=!1,this.sk.noLoop(),t.setMouseNavEnabled(!0),this.sk.mousePressed=C.noop;const r=D({},this.drawMethod.drawOptions);switch((o=this.drawMethod.drawOptions)==null?void 0:o.type){case"circle":case"rect":case"line":r.path=[[this.drawMethod.drawOptions.startPointTransformed.x,this.drawMethod.drawOptions.startPointTransformed.y],[this.drawMethod.drawOptions.endPoint.x,this.drawMethod.drawOptions.endPoint.y]];break;case"free":r.path=this.drawMethod.drawOptions.freePath;break}this.markerStore.push(r),this.drawMethod.drawOptions={},this.sk.mouseReleased=C.noop}},draw:(e,r,s,o,d)=>{var m,x,k,b;if(s===1?r.enable&&e.mouseIsPressed&&r&&r.startPoint&&e.mouseButton===e.LEFT:!0){e.push();const v=e.color(r.color);v.setAlpha(e.map(r.opacity,0,1,0,255)),r.startPointTransformed=d==null?void 0:d.viewerElementToImageCoordinates(r.startPoint),r.endPoint=d==null?void 0:d.viewerElementToImageCoordinates(new n.exports.Point(e.mouseX,e.mouseY));let l,h;const f=r.strokeWeight*t.viewport.getMinZoom()/t.viewport.getHomeZoom();switch(s===1?(l=r.startPointTransformed,h=r.endPoint):(l=new n.exports.Point(...r.path[0]),h=new n.exports.Point(...((m=r.path)==null?void 0:m[1])||[0,0])),["circle","rect","line","free"].includes(r.type)&&(e.noFill(),e.strokeWeight(f*2),e.stroke(v)),r==null?void 0:r.type){case"circle":e.circle(l.x,l.y,l.distanceTo(h)*2);break;case"rect":e.quad(l.x,l.y,h.x,l.y,h.x,h.y,l.x,h.y);break;case"line":e.line(l.x,l.y,h.x,h.y);break;case"free":s==1&&(((x=r.freePath)==null?void 0:x.length)===0&&r.freePath.push([l.x,l.y]),new n.exports.Point(...C.last(r.freePath)).distanceTo(h)>20&&((k=r.freePath)==null||k.push([h.x,h.y]))),(b=r[s===1?"freePath":"path"])==null||b.forEach((y,F)=>{var S;const R=(S=r.freePath)==null?void 0:S[F+1];R&&e.line(...y,...R)});break;case"text":(s===1?r.isInputOk:!0)&&(e.textSize(f*25),e.fill(v),e.text(r.text,l.x,l.y));break}e.pop()}}},this.sk=new q(e=>{e.setup=()=>{const r=this.viewer.viewport.getContainerSize();e.createCanvas(r.x,r.y),e.noLoop(),this.addControl()},e.draw=()=>{let r=this.viewer.viewport.getZoom(!0);e.clear();for(let s=0,o=this.viewer.world.getItemCount();s<o;s++){let d=this.viewer.world.getItemAt(s);if(d){let g=d.viewportToImageZoom(r),m=d.imageToViewportCoordinates(0,0,!0),x=this.viewer.viewport.pixelFromPoint(m,!0);this.crop.cropInfo.enable||(e.push(),e.translate(x.x,x.y),e.scale(g,g),this.drawMarkStore(r),this.drawMethod.draw(e,this.drawMethod.drawOptions,1,r,d),e.pop()),this.crop.doCrop()}}}},this.wrapDiv),this.crop=new E(this),this.viewer.addHandler("open",this.redraw.bind(this)),this.viewer.addHandler("update-viewport",this.redraw.bind(this)),this.viewer.addHandler("resize",this.resizeCanvas.bind(this))}resizeCanvas(){var i,e;const t=this.viewer.viewport.getContainerSize();(i=this.sk)==null||i.resizeCanvas(t.x,t.y,!1),(e=this.crop)==null||e.resize()}redraw(){var t;(t=this.sk)==null||t.redraw()}addControl(){const t=document.createElement("div");this.viewer.container.append(t),setTimeout(()=>{H.exports.render(M.exports.createElement(this.ControlPanel,{overlay:this},null),t)},0)}setMarkStore(t){this.markerStore=t,this.redraw()}drawMarkStore(t){this.markerStore.forEach(i=>{this.drawMethod.draw(this.sk,i,2,t)})}}function ne(){const c=M.exports.useRef(null),t=M.exports.useRef(new n.exports.TileSource({width:7026,height:9221,tileSize:256,tileOverlap:2,getTileUrl(i,e,r){return`//openseadragon.github.io//example-images/highsmith/highsmith_files/${i}/${e}_${r}.jpg`}}));return M.exports.useEffect(()=>{let i;return c.current&&(i=$({element:c.current,crossOriginPolicy:"Anonymous",showNavigationControl:!1,showNavigator:!0,navigatorAutoFade:!1,navigatorAutoResize:!1,navigatorHeight:100,navigatorWidth:200,navigatorPosition:"TOP_LEFT",tileSources:[t.current],gestureSettingsMouse:{dblClickToZoom:!1,clickToZoom:!1}}),C.set(window,"viewer",i),new oe(i,{})),()=>{i.destroy()}},[c.current]),a("div",{children:a("div",{className:"h-100vh w-full z-1",ref:c})})}G.render(a(K.StrictMode,{children:a(ne,{})}),document.getElementById("root"));
