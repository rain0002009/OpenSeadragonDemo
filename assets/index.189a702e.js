var U=Object.defineProperty,Y=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;var F=(n,t,s)=>t in n?U(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s,z=(n,t)=>{for(var s in t||(t={}))X.call(t,s)&&F(n,s,t[s]);if(T)for(var s of T(t))_.call(t,s)&&F(n,s,t[s]);return n},A=(n,t)=>Y(n,j(t));var u=(n,t,s)=>(F(n,typeof t!="symbol"?t+"":t,s),s);import{u as O,j as m,a as o,S as V,C as Q,B as b,L as Z,I as q,r as C,F as D,P as W,b as $,M as B,c as H,o as c,e as G,_ as R,d as K,O as J,R as ee,f as te}from"./vendor.b5551291.js";const ie=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))e(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function s(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerpolicy&&(i.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?i.credentials="include":r.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(r){if(r.ep)return;r.ep=!0;const i=s(r);fetch(r.href,i)}};ie();const re=[{type:"circle",label:"\u5706\u5F62"},{type:"rect",label:"\u77E9\u5F62"},{type:"line",label:"\u76F4\u7EBF"},{type:"free",label:"\u81EA\u7531"},{type:"text",label:"\u6587\u5B57"}],se=({onChange:n})=>{const t=O({strokeWeight:10,opacity:1,color:"#3f51b5",type:null});return m("div",{className:"w-230px space-y-4",children:[m("div",{children:[o("p",{children:"\u753B\u7B14\u7C97\u7EC6\uFF1A"}),o(V,{min:10,max:100,onChange:s=>{t.strokeWeight=s}})]}),m("div",{children:[o("p",{children:"\u900F\u660E\u5EA6\uFF1A"}),o(V,{min:.1,max:1,step:.1,defaultValue:1,onChange:s=>{t.opacity=s}})]}),m("div",{children:[o("p",{children:"\u989C\u8272\uFF1A"}),o(Q,{onChange:s=>{t.color=s.hex}})]}),m("div",{children:[o("p",{children:"\u7C7B\u578B\uFF1A"}),o("div",{className:"grid grid-cols-3 gap-1",children:re.map(({type:s,label:e})=>o(b,{onClick:()=>{t.type=s,n==null||n(t)},children:e},s))})]})]})},oe=({value:n})=>o(Z,{className:"w-200px",data:n||[],itemKey:"key",itemHeight:116,height:((n==null?void 0:n.length)||0)>3?3*116:void 0,children:t=>o("div",{className:"py-2 w-200px",children:o(q,{width:200,height:100,src:t.url,preview:{maskStyle:{zIndex:1100},wrapStyle:{zIndex:1100}}})},t.key)}),{Item:N}=B,ne=[{type:"fullscreen",label:"\u5168\u5C4F"},{type:"home",label:"\u4E3B\u9875"}],ae=({overlay:n})=>{const{sk:t,viewer:s,drawMethod:e,markerStore:r}=n,i=O({markVisibility:!1,inputVisibility:!1,cropVisibility:!1,cropList:[],inputText:""});return C.exports.useEffect(()=>{const a=h=>{i.cropList=h};return n.overlayEvent.on("cropStoreChange",a),()=>{n.overlayEvent.off("cropStoreChange",a)}},[]),t?m(D,{children:[o(W,{zIndex:10,visible:i.inputVisibility,content:m("div",{className:"space-y-4 w-300px",children:[o($,{autoFocus:!0,value:i.inputText,onChange:a=>{i.inputText=a.target.value}}),m("div",{className:"flex",children:[o(b,{onClick:()=>{i.inputVisibility=!1,i.inputText="",t.noLoop(),s.setMouseNavEnabled(!0),e.drawOptions.enable=!1},children:"\u53D6\u6D88"}),o(b,{type:"primary",className:"ml-auto",onClick:()=>{i.inputVisibility=!1,e.drawOptions.isInputOk=!0,r.push(A(z({},e.drawOptions),{path:[[e.drawOptions.startPointTransformed.x,e.drawOptions.startPointTransformed.y]],text:i.inputText})),t.noLoop(),s.setMouseNavEnabled(!0),i.inputText="",e.drawOptions.enable=!1},children:"\u786E\u8BA4"})]})]}),children:o("div",{id:"inputWrap"})}),o("div",{className:"absolute right-0 w-100px",children:m(B,{mode:"inline",className:"border border-color-[#dedede] shadow",children:[ne.map(({type:a,label:h})=>o(N,{onClick:({key:g})=>{switch(g){case"fullscreen":s.setFullScreen(!0);break;case"home":s.viewport.goHome(!0);break}},children:h},a)),o(N,{style:{paddingLeft:24},children:o("div",{className:"absolute top-0 right-0 bottom-0 left-0 flex items-center",children:o(W,{className:"pl-24px",placement:"leftTop",title:o("p",{children:"\u6807\u6CE8"}),content:o(se,{onChange:a=>{i.markVisibility=!1,e.drawOptions=a,e.startDraw(()=>{i.inputVisibility=!0})}}),trigger:"click",visible:i.markVisibility,children:o("a",{onClick:()=>{i.markVisibility=!i.markVisibility,i.cropVisibility=!1},children:"\u6807\u6CE8"})})})},"mark"),o(N,{style:{paddingLeft:24},children:o("div",{className:"absolute top-0 right-0 bottom-0 left-0 flex items-center",children:o(W,{className:"pl-24px",placement:"leftTop",style:{zIndex:1e3},title:m(D,{children:[o(b,{type:"primary",size:"small",onClick:()=>{n.crop.startCrop(),i.cropVisibility=!1},children:"\u5F00\u59CB"}),o(b,{type:"primary",size:"small",danger:!0,className:"ml-4",onClick:()=>{i.cropVisibility=!1,n.crop.cancelCrop()},children:"\u53D6\u6D88"})]}),content:o(oe,{value:i.cropList}),visible:i.cropVisibility,children:o("a",{onClick:()=>{i.markVisibility=!1,i.cropVisibility=!i.cropVisibility},children:"\u88C1\u526A"})})})},"crop")]})})]}):null},d=8,P=d/2,ce=34;class M{constructor(t){u(this,"viewer");u(this,"sk");u(this,"cropInfo",{});u(this,"buttonWrapperDiv");u(this,"pg");u(this,"onFinish");this.onFinish=t.onCropFinish,this.viewer=t.viewer,this.sk=t.sk,this.buttonWrapperDiv=this.sk.createDiv(),this.buttonWrapperDiv.hide(),this.buttonWrapperDiv.addClass("w-120px");const s=this.viewer.viewport.getContainerSize();this.pg=this.sk.createGraphics(s.x,s.y),H.exports.render(m(D,{children:[o(b,{size:"small",type:"primary",onClick:()=>{this.finish()},children:"\u786E\u5B9A"}),o(b,{className:"ml-4",size:"small",danger:!0,type:"primary",onClick:()=>{this.cancelCrop()},children:"\u53D6\u6D88"})]}),this.buttonWrapperDiv.elt),this.viewer.container.append(this.buttonWrapperDiv.elt)}startCrop(){if(this.cropInfo.enable)return!1;this.cropInfo.prevCanvasImage=this.sk.get(),this.viewer.setMouseNavEnabled(!1),this.viewer.drawer.canvas.toBlob(t=>{if(t){const s=URL.createObjectURL(t);this.sk.loadImage(s,e=>{this.cropInfo.seaDragonImage=e,URL.revokeObjectURL(s)})}}),this.sk.loop(),this.cropInfo.enable=!0,this.sk.mousePressed=t=>(!this.cropInfo.enable||t.target.nodeName!=="CANVAS"||this.cropInfo.onWhere||(this.cropInfo.startPoint=new c.exports.Point(this.sk.mouseX,this.sk.mouseY),this.cropInfo.currentSelected=void 0),!1),this.sk.mouseReleased=t=>{if(!this.cropInfo.enable||t.target.nodeName!=="CANVAS")return!1;this.cropInfo.currentSelected||(this.cropInfo.currentSelected=[this.cropInfo.startPoint,new c.exports.Point(this.sk.mouseX,this.sk.mouseY)],this.buttonWrapperDiv.show()),this.cropInfo.startPoint=void 0}}cancelCrop(){this.buttonWrapperDiv.hide(),this.viewer.setMouseNavEnabled(!0),this.sk.noLoop(),this.sk.cursor(this.sk.ARROW),this.cropInfo={}}doCrop(){if(this.cropInfo.enable){this.cropInfo.seaDragonImage&&this.sk.image(this.cropInfo.seaDragonImage,0,0,this.sk.width,this.sk.height),this.sk.image(this.cropInfo.prevCanvasImage,0,0,this.sk.width,this.sk.height);const t=this.cropInfo.startPoint,s=new c.exports.Point(this.sk.mouseX,this.sk.mouseY);this.cropInfo.onWhere||this.sk.cursor(this.sk.CROSS),t&&this.drawQuad(t,s),this.cropInfo.currentSelected&&(this.drawQuad(...this.cropInfo.currentSelected),this.transformQuad(...this.cropInfo.currentSelected))}}drawQuad(t,s){if(t&&"globalCompositeOperation"in this.pg.drawingContext){const e=[new c.exports.Point(t.x,t.y),new c.exports.Point(s.x,t.y),new c.exports.Point(s.x,s.y),new c.exports.Point(t.x,s.y)];this.pg.clear(),this.pg.background(0,0,0,120),this.pg.push(),this.pg.drawingContext.globalCompositeOperation="destination-out",this.pg.fill(255,255,255,255),this.pg.quad(e[0].x,e[0].y,e[1].x,e[1].y,e[2].x,e[2].y,e[3].x,e[3].y),this.pg.pop(),this.pg.push(),this.pg.noFill(),this.pg.stroke(0,0,255),this.pg.strokeWeight(2),this.pg.quad(e[0].x,e[0].y,e[1].x,e[1].y,e[2].x,e[2].y,e[3].x,e[3].y),e.forEach(r=>{this.pg.fill(0,0,255),this.pg.square(r.x-P,r.y-P,d)}),this.pg.pop(),this.sk.image(this.pg,0,0,this.sk.width,this.sk.height)}}transformQuad(t,s){var p;if(!t)return!1;const e=new c.exports.Point(this.sk.mouseX,this.sk.mouseY),{mainRect:r,leftRect:i,rightRect:a,bottomRect:h,topRect:g,topLeftRect:w,topRightRect:x,bottomLeftRect:k,bottomRightRect:I,topLeftPoint:y}=M.getRectFromPoint(t,s);if(this.buttonWrapperDiv.position(y.x,y.y-ce),this.sk.mouseIsPressed||(this.cropInfo.onWhere=void 0,r.containsPoint(e)&&(this.sk.cursor(this.sk.MOVE),this.cropInfo.onWhere="inside"),[{cursor:"ns-resize",rect:g,onWhere:"top"},{cursor:"ew-resize",rect:a,onWhere:"right"},{cursor:"ns-resize",rect:h,onWhere:"bottom"},{cursor:"ew-resize",rect:i,onWhere:"left"},{cursor:"nwse-resize",rect:w,onWhere:"topLeft"},{cursor:"nesw-resize",rect:x,onWhere:"topRight"},{cursor:"nwse-resize",rect:I,onWhere:"bottomRight"},{cursor:"nesw-resize",rect:k,onWhere:"bottomLeft"}].forEach(({cursor:l,rect:f,onWhere:v})=>{f.containsPoint(e)&&(this.sk.cursor(l),this.cropInfo.onWhere=v)})),this.sk.mouseIsPressed){const l=e.x-this.sk.pmouseX,f=e.y-this.sk.pmouseY;switch(this.cropInfo.onWhere){case"inside":(p=this.cropInfo.currentSelected)==null||p.forEach(v=>{v.x+=l,v.y+=f});break;case"top":this.cropInfo.currentSelected[0].y+=f;break;case"right":this.cropInfo.currentSelected[1].x+=l;break;case"bottom":this.cropInfo.currentSelected[1].y+=f;break;case"left":this.cropInfo.currentSelected[0].x+=l;break;case"topLeft":this.cropInfo.currentSelected[0].x+=l,this.cropInfo.currentSelected[0].y+=f;break;case"topRight":this.cropInfo.currentSelected[1].x+=l,this.cropInfo.currentSelected[0].y+=f;break;case"bottomRight":this.cropInfo.currentSelected[1].x+=l,this.cropInfo.currentSelected[1].y+=f;break;case"bottomLeft":this.cropInfo.currentSelected[0].x+=l,this.cropInfo.currentSelected[1].y+=f;break}}}finish(){const[t,s]=this.cropInfo.currentSelected,{mainInsideRect:e}=M.getRectFromPoint(t,s);this.cropInfo.enable=!1,this.sk.noLoop(),this.sk.clear(),this.cropInfo.seaDragonImage&&this.sk.image(this.cropInfo.seaDragonImage,0,0,this.sk.width,this.sk.height),this.sk.image(this.cropInfo.prevCanvasImage,0,0,this.sk.width,this.sk.height),this.sk.get(e.x,e.y,e.width,e.height).canvas.toBlob(i=>{var a;if(i){const h=URL.createObjectURL(i);(a=this.onFinish)==null||a.call(this,{blob:i,url:h,key:h})}}),this.cancelCrop()}resize(){const t=this.viewer.viewport.getContainerSize();this.pg.resizeCanvas(t.x,t.y)}static getRectFromPoint(t,s){const e=new c.exports.Point(Math.min(t.x,s.x),Math.min(t.y,s.y)),r=new c.exports.Point(Math.max(t.x,s.x),Math.max(t.y,s.y)),i=new c.exports.Point(e.x-P,e.y-P),a=new c.exports.Point(r.x+P,r.y+P),h=a.x-i.x,g=r.x-e.x,w=a.y-i.y,x=r.y-e.y,k=new c.exports.Rect(i.x,i.y,h,w),I=new c.exports.Rect(e.x,e.y,g,x),y=new c.exports.Rect(i.x,i.y,h,d),p=new c.exports.Rect(a.x-d,i.y,d,w),l=new c.exports.Rect(i.x,a.y-d,h,d),f=new c.exports.Rect(i.x,i.y,d,w),v=new c.exports.Rect(i.x,i.y,d,d),L=new c.exports.Rect(a.x-d,i.y,d,d),S=new c.exports.Rect(i.x,a.y-d,d,d),E=new c.exports.Rect(a.x-d,a.y-d,d,d);return{mainRect:k,topRect:y,topLeftPoint:i,rightRect:p,bottomRect:l,leftRect:f,topLeftRect:v,topRightRect:L,bottomLeftRect:S,bottomRightRect:E,mainInsideRect:I}}}class he{constructor(t,s){u(this,"viewer");u(this,"wrapDiv");u(this,"sk");u(this,"drawMethod");u(this,"markerStore");u(this,"ControlPanel");u(this,"crop");u(this,"onCropFinish");u(this,"cropStore");u(this,"overlayEvent");this.overlayEvent=new G.exports.EventEmitter,this.cropStore=new Proxy(s.cropStore||[],{set:(e,r,i)=>(e[r]=i,this.overlayEvent.emit("cropStoreChange",e),!0)}),this.onCropFinish=s.onCropFinish||this.defaultCropFinish.bind(this),this.ControlPanel=s.ControlPanel||ae,this.markerStore=s.markerStore||[],this.viewer=t,this.wrapDiv=document.createElement("div"),this.wrapDiv.classList.add("p5-wrap"),this.viewer.canvas.append(this.wrapDiv),this.drawMethod={drawOptions:{},startDraw:e=>{this.crop.cancelCrop(),this.drawMethod.drawOptions.enable=!0,t.setMouseNavEnabled(!1),this.drawMethod.drawOptions.startPoint=null,this.drawMethod.drawOptions.endPoint=null,this.drawMethod.drawOptions.startPointTransformed=null,this.drawMethod.drawOptions.freePath=[],this.sk.loop(),this.sk.mousePressed=()=>{var r;if(this.drawMethod.drawOptions.startPoint=new c.exports.Point(this.sk.mouseX,this.sk.mouseY),((r=this.drawMethod.drawOptions)==null?void 0:r.type)==="text"){const i=this.sk.select("#inputWrap");i?(i==null||i.position(this.drawMethod.drawOptions.startPoint.x,this.drawMethod.drawOptions.startPoint.y),e==null||e()):console.error("inputWrap is null")}},this.sk.mouseReleased=()=>{var i,a;if(((i=this.drawMethod.drawOptions)==null?void 0:i.type)==="text")return this.sk.mousePressed=R.noop,!1;this.drawMethod.drawOptions.enable=!1,this.sk.noLoop(),t.setMouseNavEnabled(!0),this.sk.mousePressed=R.noop;const r=z({},this.drawMethod.drawOptions);switch((a=this.drawMethod.drawOptions)==null?void 0:a.type){case"circle":case"rect":case"line":r.path=[[this.drawMethod.drawOptions.startPointTransformed.x,this.drawMethod.drawOptions.startPointTransformed.y],[this.drawMethod.drawOptions.endPoint.x,this.drawMethod.drawOptions.endPoint.y]];break;case"free":r.path=this.drawMethod.drawOptions.freePath;break}this.markerStore.push(r),this.drawMethod.drawOptions={},this.sk.mouseReleased=R.noop}},draw:(e,r,i,a,h)=>{var w,x,k,I;if(i===1?r.enable&&e.mouseIsPressed&&r&&r.startPoint&&e.mouseButton===e.LEFT:!0){e.push();const y=e.color(r.color);y.setAlpha(e.map(r.opacity,0,1,0,255)),r.startPointTransformed=h==null?void 0:h.viewerElementToImageCoordinates(r.startPoint),r.endPoint=h==null?void 0:h.viewerElementToImageCoordinates(new c.exports.Point(e.mouseX,e.mouseY));let p,l;const f=r.strokeWeight*t.viewport.getMinZoom()/t.viewport.getHomeZoom();switch(i===1?(p=r.startPointTransformed,l=r.endPoint):(p=new c.exports.Point(...r.path[0]),l=new c.exports.Point(...((w=r.path)==null?void 0:w[1])||[0,0])),["circle","rect","line","free"].includes(r.type)&&(e.noFill(),e.strokeWeight(f*2),e.stroke(y)),r==null?void 0:r.type){case"circle":e.circle(p.x,p.y,p.distanceTo(l)*2);break;case"rect":e.quad(p.x,p.y,l.x,p.y,l.x,l.y,p.x,l.y);break;case"line":e.line(p.x,p.y,l.x,l.y);break;case"free":i==1&&(((x=r.freePath)==null?void 0:x.length)===0&&r.freePath.push([p.x,p.y]),new c.exports.Point(...R.last(r.freePath)).distanceTo(l)>20&&((k=r.freePath)==null||k.push([l.x,l.y]))),(I=r[i===1?"freePath":"path"])==null||I.forEach((v,L)=>{var E;const S=(E=r.freePath)==null?void 0:E[L+1];S&&e.line(...v,...S)});break;case"text":(i===1?r.isInputOk:!0)&&(e.textSize(f*25),e.fill(y),e.text(r.text,p.x,p.y));break}e.pop()}}},this.sk=new K(e=>{e.setup=()=>{const r=this.viewer.viewport.getContainerSize();e.createCanvas(r.x,r.y),e.noLoop(),this.addControl()},e.draw=()=>{let r=this.viewer.viewport.getZoom(!0);e.clear();for(let i=0,a=this.viewer.world.getItemCount();i<a;i++){let h=this.viewer.world.getItemAt(i);if(h){let g=h.viewportToImageZoom(r),w=h.imageToViewportCoordinates(0,0,!0),x=this.viewer.viewport.pixelFromPoint(w,!0);this.crop.cropInfo.enable||(e.push(),e.translate(x.x,x.y),e.scale(g,g),this.drawMarkStore(r),this.drawMethod.draw(e,this.drawMethod.drawOptions,1,r,h),e.pop()),this.crop.doCrop()}}}},this.wrapDiv),this.crop=new M(this),this.viewer.addHandler("open",this.redraw.bind(this)),this.viewer.addHandler("update-viewport",this.redraw.bind(this)),this.viewer.addHandler("resize",this.resizeCanvas.bind(this))}resizeCanvas(){var s,e;const t=this.viewer.viewport.getContainerSize();(s=this.sk)==null||s.resizeCanvas(t.x,t.y,!1),(e=this.crop)==null||e.resize()}redraw(){var t;(t=this.sk)==null||t.redraw()}addControl(){const t=document.createElement("div");this.viewer.container.append(t),setTimeout(()=>{H.exports.render(C.exports.createElement(this.ControlPanel,{overlay:this},null),t)},0)}setMarkStore(t){this.markerStore=t,this.redraw()}drawMarkStore(t){this.markerStore.forEach(s=>{this.drawMethod.draw(this.sk,s,2,t)})}defaultCropFinish(t){this.cropStore.push(t)}}function le(){const n=C.exports.useRef(null),t=C.exports.useRef(new c.exports.TileSource({width:7026,height:9221,tileSize:256,tileOverlap:2,getTileUrl(s,e,r){return`//openseadragon.github.io//example-images/highsmith/highsmith_files/${s}/${e}_${r}.jpg`}}));return C.exports.useEffect(()=>{let s;return n.current&&(s=J({element:n.current,crossOriginPolicy:"Anonymous",showNavigationControl:!1,showNavigator:!0,navigatorAutoFade:!1,navigatorAutoResize:!1,navigatorHeight:100,navigatorWidth:200,navigatorPosition:"TOP_LEFT",tileSources:[t.current],gestureSettingsMouse:{dblClickToZoom:!1,clickToZoom:!1}}),R.set(window,"viewer",s),new he(s,{})),()=>{s.destroy()}},[n.current]),o("div",{children:o("div",{className:"h-100vh w-full z-1",ref:n})})}ee.render(o(te.StrictMode,{children:o(le,{})}),document.getElementById("root"));
